<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katalog | Auto Plac Mirko</title>
    <style>
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #c0392b;
            --text-color: #2c3e50;
            --light-gray: #7f8c8d;
            --bg-color: #f8f9fa;
            --white: #ffffff;
            --black: #222;
            --shadow: rgba(0,0,0,0.13);
            --border-radius: 8px;
            --header-height: 120px;
            --container-padding: clamp(16px, 2vw, 24px);
            --gap-small: clamp(8px, 1vw, 12px);
            --gap-medium: clamp(16px, 2vw, 24px);
            --gap-large: clamp(24px, 3vw, 40px);
            --font-size-small: clamp(0.8rem, 1.5vw, 0.9rem);
            --font-size-base: clamp(0.9rem, 2vw, 1rem);
            --font-size-medium: clamp(1rem, 2.5vw, 1.2rem);
            --font-size-large: clamp(1.2rem, 3vw, 1.4rem);
            --font-size-xl: clamp(1.4rem, 4vw, 1.8rem);
            --font-size-title: clamp(2rem, 5vw, 3rem);
        }
        
        html {
            scroll-behavior: smooth;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--bg-color);
            padding-top: var(--header-height);
            /* Vidljiv scrollbar radi jasnog feedback-a korisniku */
            overflow-y: auto;
            /* Sakrij scrollbar (scroll ostaje aktivan) */
            -ms-overflow-style: none; /* IE / stari Edge */
            scrollbar-width: none; /* Firefox */
        }
        body::-webkit-scrollbar { display: none; }
        /* Zakljuƒçavanje skrola samo kada je otvoren modal */
        body.no-scroll {
            overflow: hidden !important;
            height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-left: var(--container-padding);
            padding-right: var(--container-padding);
        }
        header {
            background: var(--black);
            color: var(--white);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: headerFadeIn 1.2s cubic-bezier(.4,0,.2,1);
        }
        @keyframes headerFadeIn {
            from { opacity: 0; transform: translateY(-40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .header-top { background: #333; padding: 8px 0; font-size: 14px; }
        .header-info { display: flex; justify-content: space-between; align-items: center; }
        .contact-info { display: flex; gap: 30px; }
        .contact-info span { display: flex; align-items: center; gap: 8px; }
        nav { padding: 15px 0; }
        .nav-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 15px; font-size: var(--font-size-xl); font-weight: bold; color: var(--primary-color); cursor: pointer; }
        .logo img { height: 50px; width: auto; }
        .nav-links { display: flex; list-style: none; gap: var(--gap-large); }
        .nav-links a { text-decoration: none; color: var(--white); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; transition: color 0.3s ease; position: relative; }
        .nav-links a:hover { color: var(--primary-color); }
        .nav-links a::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -5px; left: 0; background: var(--primary-color); transition: width 0.3s ease; }
        .nav-links a:hover::after { width: 100%; }
        
        /* Dropdown hover efekat */
        #katalogDropdownLi:hover #katalogDropdown {
            display: block !important;
        }
        
        #katalogDropdown {
            transition: opacity 0.2s ease;
        }
        
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--white);
            cursor: pointer;
            padding: 5px;
            z-index: 1001;
        }
        main.main-content {
            margin-top: 0;
            min-height: calc(100vh - var(--header-height) - 250px);
            background: var(--bg-color);
            display: block;
        }
        .section {
            padding: 80px 0;
            animation: sectionFadeIn 1.2s cubic-bezier(.4,0,.2,1);
        }
        @keyframes sectionFadeIn {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section-title { text-align: center; margin-bottom: 60px; }
        .section-title h2 {
            font-size: var(--font-size-title); font-weight: 700; color: #1a1a1a; margin-bottom: 15px; position: relative; display: inline-block;
            letter-spacing: 1.5px;
            animation: titlePop 1.1s cubic-bezier(.4,0,.2,1);
        }
        @keyframes titlePop {
            from { opacity: 0; transform: scale(0.95) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .section-title p { font-size: var(--font-size-medium); color: var(--light-gray); max-width: 600px; margin: 0 auto; }
        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            width: 100%;
            margin: 0 auto;
            max-width: 1400px;
        }
        .car-card {
            background: linear-gradient(120deg, var(--white) 70%, #f3f6fb 100%);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow);
            padding: 0;
            display: flex;
            flex-direction: column;
            min-width: 0;
            height: auto;
            min-height: 420px;
            transition: transform 0.25s cubic-bezier(.4,0,.2,1), box-shadow 0.25s;
            will-change: transform, box-shadow;
            animation: cardPopIn 0.8s cubic-bezier(.4,0,.2,1);
            color: #222;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .car-card .car-specs,
        .car-card .car-stats,
        .car-card b,
        .car-card span,
        .car-card div {
            color: #222 !important;
        }
        .car-card:hover {
            transform: translateY(-8px) scale(1.025);
            box-shadow: 0 16px 48px rgba(231,76,60,0.13), 0 2px 8px rgba(0,0,0,0.08);
        }
        @keyframes cardPopIn {
            from { opacity: 0; transform: scale(0.96) translateY(40px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .car-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #aaa;
        }
        .car-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .car-title {
            font-size: var(--font-size-large);
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
            line-height: 1.2;
        }
        .car-price {
            font-size: var(--font-size-large);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 12px;
        }
        .car-specs-compact {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
            flex: 1;
        }
        .car-specs-compact .spec-item {
            font-size: var(--font-size-small);
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        .car-specs-compact .spec-label {
            font-weight: 600;
            color: var(--light-gray);
        }
        .load-more-btn {
            background: linear-gradient(90deg, var(--primary-color) 60%, #ffb199 100%);
            color: var(--white);
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: var(--font-size-small);
            transition: background 0.2s, transform 0.2s;
            margin-top: auto;
            width: 100%;
        }
        .load-more-btn:hover {
            background: linear-gradient(90deg, var(--secondary-color) 60%, var(--primary-color) 100%);
            transform: translateY(-2px);
        }
        .car-buttons {
            display: flex;
            gap: 8px;
            margin-top: auto;
            visibility: visible;
            opacity: 1;
        }
        .car-buttons .load-more-btn {
            flex: 1;
        }
        .delete-btn {
            background: linear-gradient(90deg, #dc3545 60%, #ff6b7a 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s, transform 0.2s;
            flex: 1;
            display: block; /* Eksplicitno prika≈æi */
            visibility: visible;
            opacity: 1;
        }
        .delete-btn:hover {
            background: linear-gradient(90deg, #c82333 60%, #dc3545 100%);
            transform: translateY(-2px);
        }
        .car-specs {
            width: 100%;
            margin-bottom: 10px;
        }
        .car-specs label {
            display: block;
            font-weight: 600;
            margin-bottom: 3px;
            color: #e74c3c;
        }
        .car-specs input, .car-specs textarea {
            width: 100%;
            min-width: 0;
            box-sizing: border-box;
            padding: 7px 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .car-specs textarea { resize: vertical; min-height: 40px; }
        .car-actions { margin-top: 10px; }
        .car-actions button {
            background: linear-gradient(90deg, #e74c3c 60%, #ffb199 100%);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(231,76,60,0.10);
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            outline: none;
        }
        .car-actions button:hover {
            background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%);
            transform: scale(1.07);
            box-shadow: 0 6px 18px rgba(231,76,60,0.18);
        }
        .car-slider {
            transition: box-shadow 0.2s;
        }
        .car-slider:hover {
            box-shadow: 0 6px 24px rgba(231,76,60,0.13);
        }
        .slider-thumbs img {
            transition: transform 0.18s, box-shadow 0.18s, opacity 0.18s;
        }
        .slider-thumbs img:hover {
            transform: scale(1.13) rotate(-2deg);
            box-shadow: 0 2px 12px rgba(231,76,60,0.18);
            opacity: 1 !important;
        }
        footer {
            background: #222;
    color: white;
    padding: 50px 0 30px;
    text-align: center;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
    animation: footerFadeIn 1.2s cubic-bezier(.4,0,.2,1);
    position: static;
    width: 100%;
    bottom: 0;
    left: 0;
        }
        @keyframes footerFadeIn {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-section h3 { font-size: 1.3rem; margin-bottom: 20px; color: #e74c3c; cursor: pointer; }
        .footer-section p, .footer-section a { color: #bbb; text-decoration: none; line-height: 1.8; }
        .footer-section a:hover { color: #e74c3c; }
        .footer-bottom { border-top: 1px solid #333; padding-top: 20px; font-size: 14px; color: #999; }
        #adminPanel {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.10);
            padding: 12px 8px 8px 8px;
            max-width: 420px;
            margin: 24px auto 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0;
            overflow-y: auto;
        }
        /* --- Novi profesionalni stil za modal & formu --- */
        .modal-overlay {
            display:none;position:fixed;z-index:2000;inset:0;width:100vw;height:100vh;
            background:linear-gradient(rgba(30,33,40,0.62),rgba(30,33,40,0.62));
            backdrop-filter:blur(4px) saturate(140%);
            -webkit-backdrop-filter:blur(4px) saturate(140%);
            justify-content:center;align-items:flex-start;padding:40px 18px 50px;overflow-y:auto;
        }
        .modal-panel {
            position:relative;background:#ffffff;
            border-radius:20px;
            box-shadow:0 12px 48px -8px rgba(0,0,0,0.25),0 2px 8px rgba(0,0,0,0.08);
            width:100%;max-width:640px;display:flex;flex-direction:column;
            padding:0;overflow:hidden;animation:panelIn .55s cubic-bezier(.4,0,.2,1);
        }
        @keyframes panelIn { from { opacity:0; transform:translateY(32px) scale(.97);} to { opacity:1; transform:translateY(0) scale(1);} }
        .modal-panel-header { background:linear-gradient(120deg,#e74c3c,#ff9b7a); padding:20px 28px 18px; color:#fff; position:relative; }
        .modal-panel-header h2 { margin:0;font-size:1.35rem;letter-spacing:.5px;font-weight:600; }
        .modal-panel-header p { margin:4px 0 0;font-size:.85rem;opacity:.92; }
        .modal-close-btn { position:absolute;top:10px;right:12px;background:rgba(255,255,255,0.18);border:none;width:40px;height:40px;border-radius:12px;cursor:pointer;font-size:1.6rem;color:#fff;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);transition:background .25s,transform .25s; }
        .modal-close-btn:hover { background:rgba(255,255,255,0.35); transform:rotate(90deg); }
        .admin-form-body { padding:26px 30px 30px; display:flex; flex-direction:column; gap:22px; }
        .admin-form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px 24px; }
        .form-group { display:flex; flex-direction:column; position:relative; }
        .form-group label { font-size:.83rem; text-transform:uppercase; letter-spacing:.9px; font-weight:600; color:#e74c3c; margin:0 0 6px; }
        .form-group input[type=text],
        .form-group input[type=number],
        .form-group select,
        .form-group textarea { background:#fdfdfd; border:1px solid #d5d8de; border-radius:10px; padding:10px 13px; font-size:.95rem; line-height:1.25; transition:border-color .2s, box-shadow .2s, background .25s; font-family:inherit; }
        .form-group textarea { resize:vertical; min-height:150px; }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus { outline:none; border-color:#e74c3c; box-shadow:0 0 0 3px rgba(231,76,60,.25); background:#fff; }
        .form-group input:disabled { opacity:.6; cursor:not-allowed; }
        .form-row-span { grid-column:1/-1; }
        /* Custom file input */
    .file-input-wrap { position:relative; }
    .file-picker { display:flex; align-items:center; gap:14px; flex-wrap:wrap; background:#fcfcfc; border:1px dashed #e0e3e7; padding:14px 16px; border-radius:16px; }
    .file-trigger-btn { background:linear-gradient(90deg,#e74c3c,#ff9b7a); color:#fff; border:none; padding:12px 22px; border-radius:12px; font-size:.8rem; font-weight:600; letter-spacing:.6px; cursor:pointer; box-shadow:0 4px 14px -4px rgba(231,76,60,.55); transition:background .25s,transform .25s; }
    .file-trigger-btn:hover { transform:translateY(-2px); }
    .file-trigger-btn:active { transform:translateY(0); }
    .file-info { font-size:.72rem; letter-spacing:.6px; text-transform:uppercase; color:#666; white-space:nowrap; }
    input[type=file].hidden-file-input { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); border:0; }
        .input-hint { font-size:.66rem; letter-spacing:.6px; text-transform:uppercase; color:#888; margin-top:6px; }
        .submit-bar { display:flex; justify-content:flex-end; gap:14px; margin-top:4px; }
        .primary-btn { background:linear-gradient(90deg,#e74c3c,#ff9b7a); border:none; color:#fff; font-weight:600; letter-spacing:.5px; padding:14px 34px; border-radius:14px; cursor:pointer; font-size:.95rem; box-shadow:0 6px 20px -6px rgba(231,76,60,.45); position:relative; overflow:hidden; transition:transform .25s, box-shadow .25s; }
        .primary-btn:hover { transform:translateY(-2px); box-shadow:0 10px 28px -8px rgba(231,76,60,.55); }
        .primary-btn:active { transform:translateY(0); box-shadow:0 4px 16px -4px rgba(231,76,60,.45); }
        .primary-btn::after { content:''; position:absolute; inset:0; background:radial-gradient(circle at 30% -10%,rgba(255,255,255,.55),transparent 60%); opacity:.8; pointer-events:none; }
        .divider-line { height:1px; background:linear-gradient(90deg,transparent,#e4e6ea,transparent); margin:4px 0 0; }
        /* Scrollbar unutar panela (ako je potrebno) */
        .modal-panel::-webkit-scrollbar { width:10px; }
        .modal-panel::-webkit-scrollbar-track { background:transparent; }
        .modal-panel::-webkit-scrollbar-thumb { background:#d5dadf; border-radius:20px; border:2px solid transparent; background-clip:content-box; }
        .modal-panel:hover::-webkit-scrollbar-thumb { background:#c5cacf; border:2px solid transparent; }
        @media (max-width:680px){
            .modal-panel { border-radius:16px; }
            .admin-form-body { padding:22px 22px 26px; }
            .form-group textarea { min-height:70px; }
        }
        #adminPanel h2 {
            color: #e74c3c;
            margin-bottom: 14px;
            text-align: center;
            font-size: 1.2rem;
        }
        #adminPanel .car-specs {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 0;
        }
        #adminPanel label {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 1px;
            margin-top: 4px;
            display: block;
            font-size: 0.97rem;
        }
        #adminPanel input, #adminPanel select, #adminPanel textarea {
            background: #fff;
            color: #222;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 7px;
            margin-bottom: 0;
            font-size: 0.97rem;
            width: 100%;
            box-sizing: border-box;
        }
        #adminPanel textarea { resize: vertical; min-height: 32px; }
        #adminPanel .car-actions {
            text-align: center;
            margin-top: 10px;
        }
        #submitCarBtn {
            margin-top: 6px;
            background: linear-gradient(90deg, #e74c3c 60%, #ffb199 100%);
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: background 0.2s, transform 0.2s;
        }
        #submitCarBtn:hover {
            background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%);
            transform: scale(1.05);
        }
        @media (max-width: 900px) {
            .catalog-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }
            .car-card {
                height: 380px;
            }
        }
        @media (max-width: 768px) {
            :root {
                --header-height: 140px; /* Poveƒáana visina na mobilnom */
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .nav-content {
                justify-content: space-between;
            }
            
            .nav-links {
                position: fixed;
                top: var(--header-height);
                left: -100%;
                width: 100%;
                height: calc(100vh - var(--header-height));
                background: var(--black);
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                padding-top: 2rem;
                gap: 1.5rem;
                transition: left 0.3s ease;
                z-index: 999;
                overflow-y: auto;
            }
            
            .nav-links.active {
                left: 0;
            }
            
            .nav-links li {
                width: 90%;
                text-align: center;
            }
            
            /* Login dugme prioritet na mobile - odmah posle kataloga */
            .nav-links li:nth-child(1) { order: 1; } /* Poƒçetna */
            .nav-links li:nth-child(2) { order: 2; } /* Usluge */
            .nav-links li:nth-child(3) { order: 3; } /* O nama */
            .nav-links li:nth-child(4) { order: 4; } /* Kontakt */
            .nav-links li:nth-child(5) { order: 5; } /* Radio */
            #katalogDropdownLi { order: 6; } /* Katalog */
            #loginNavLi {
                order: 7; /* Login odmah posle kataloga */
            }
            
            #logoutNavLi {
                order: 8; /* Logout odmah posle login */
            }
            
            .nav-links a {
                display: block;
                padding: 15px 20px;
                font-size: var(--font-size-medium);
                border-bottom: 1px solid rgba(255,255,255,0.1);
                width: 100%;
            }
            
            .nav-links a:hover {
                background: rgba(231, 76, 60, 0.1);
                border-radius: var(--border-radius);
            }
            
            /* Dropdown menu mobilni prikaz */
            #katalogDropdown {
                position: static !important;
                display: block !important;
                background: rgba(255,255,255,0.1) !important;
                box-shadow: none !important;
                margin-top: 10px !important;
                border-radius: var(--border-radius) !important;
                width: 100% !important;
                min-width: auto !important;
            }
            
            #katalogDropdown a {
                color: var(--white) !important;
                border-bottom: 1px solid rgba(255,255,255,0.1) !important;
                padding: 12px 20px !important;
            }
            
            #katalogDropdown a:hover {
                background: rgba(231, 76, 60, 0.2) !important;
            }
            
            /* Login/Logout dugmad mobilni prikaz */
            #loginNavLi button,
            #logoutNavLi button {
                width: 80% !important;
                padding: 12px 20px !important;
                font-size: var(--font-size-base) !important;
                margin: 10px auto !important;
                display: block !important;
                border-radius: 8px !important;
                font-weight: 600 !important;
                z-index: 1002 !important; /* Visok z-index za iPhone kompatibilnost */
                position: relative !important;
            }
            
            /* Dodatna sigurnost za iPhone ureƒëaje */
            #loginNavLi {
                z-index: 1002 !important;
                position: relative !important;
                margin: 8px 0 !important;
            }
            
            /* Admin dugmad mobilni prikaz - FORSIRANI CSS */
            .car-buttons {
                flex-direction: column !important;
                gap: 8px !important;
                margin-top: 15px !important;
            }
            
            .car-buttons button {
                width: 100% !important;
                padding: 10px !important;
                font-size: 14px !important;
                border-radius: 6px !important;
            }
            
            /* Search bar mobilni prikaz */
            .search-container {
                flex-direction: column !important;
                gap: 10px !important;
                margin-bottom: 20px !important;
                padding: 0 15px !important;
            }
            
            #searchBar {
                width: 100% !important;
                max-width: none !important;
                border-radius: 4px !important;
                font-size: 16px !important; /* Spreƒçava zoom na iOS */
            }
            
            .search-container button {
                width: 100% !important;
                border-radius: 4px !important;
                padding: 12px 20px !important;
            }
            
            /* Admin dugmad u header sekciji */
            #addCarBtnWrap {
                margin: 20px 0 !important;
                padding: 0 15px !important;
            }
            
            /* Samo prikaz ako je admin ulogovan */
            #addCarBtnWrap:not([style*="display: none"]) button {
                width: 100% !important;
                margin: 5px 0 !important;
                display: block !important;
                font-size: 1rem !important;
                padding: 12px 20px !important;
            }
            
            /* Za gost korisnike - skriva potpuno */
            #addCarBtnWrap[style*="display: none"] {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }
            
            .car-buttons .load-more-btn {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                flex: 1 !important;
                min-height: 44px !important;
                padding: 12px 8px !important;
                font-size: clamp(0.8rem, 2.5vw, 0.9rem) !important;
                font-weight: 600 !important;
                border-radius: var(--border-radius) !important;
                cursor: pointer !important;
                touch-action: manipulation !important;
                line-height: 1.2 !important;
            }
            
            .car-buttons .delete-btn {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                flex: 1 !important;
                min-height: 44px !important;
                padding: 12px 8px !important;
                font-size: clamp(0.8rem, 2.5vw, 0.9rem) !important;
                font-weight: 600 !important;
                border-radius: var(--border-radius) !important;
                cursor: pointer !important;
                touch-action: manipulation !important;
                line-height: 1.2 !important;
                background: linear-gradient(90deg, #dc3545 60%, #ff6b7a 100%) !important;
                color: white !important;
                border: none !important;
            }
            
            .delete-btn:hover,
            .delete-btn:active {
                background: linear-gradient(90deg, #c82333 60%, #dc3545 100%) !important;
                transform: translateY(-1px) !important;
            }
            
            .container { padding: 0 var(--container-padding); }
            main.main-content { margin-top: var(--header-height); }
            .catalog-grid { grid-template-columns: 1fr; gap: var(--gap-medium) 0; }
            .car-card { max-width: 99vw; min-width: 0; }
        }
        
        /* Fullscreen galerija za slike */
        .fullscreen-gallery {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        
        .fullscreen-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .fullscreen-image {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .fullscreen-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .fullscreen-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 28px;
            cursor: pointer;
            z-index: 10000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .fullscreen-nav:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .fullscreen-prev {
            left: 20px;
        }
        
        .fullscreen-next {
            right: 20px;
        }
        
        .fullscreen-counter {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        /* Mobile optimizacije za fullscreen */
        @media (max-width: 768px) {
            .fullscreen-close {
                top: 15px;
                right: 15px;
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            
            .fullscreen-nav {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            .fullscreen-prev {
                left: 15px;
            }
            
            .fullscreen-next {
                right: 15px;
            }
            
            .fullscreen-counter {
                bottom: 20px;
                font-size: 13px;
                padding: 6px 12px;
            }
        }

            /* Mobilni header logo i natpis - samo za male ekrane */
            @media (max-width: 768px) {
                .logo img {
                    height: 40px !important;
                }
                .logo span {
                    font-size: 1.45rem !important;
                    margin-left: 10px !important;
                    letter-spacing: 0.7px !important;
                }
                .logo {
                    gap: 10px !important;
                    align-items: center !important;
                }
            }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <div class="container">
                <div class="header-info">
                    <div class="contact-info">
                        <span>üìç Prokuplje, Srbija</span>
                        <span>üïí Pon-Pet: 08:00-18:00, Sub: 08:00-15:00</span>
                    </div>
                    <div class="contact-info"></div>
                </div>
            </div>
        </div>
        <nav>
            <div class="container">
                <div class="nav-content">
                    <div class="logo" onclick="window.location.href='auto-plac-mirko (1).html'">
                        <img src="MirkoLogo.png" alt="Auto Plac Mirko" style="height:50px;width:auto;" />
                        <span style="font-size:2rem;font-weight:600;color:#e74c3c;margin-left:12px;letter-spacing:1px;">Auto Plac Mirko</span>
                    </div>
                    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                        ‚ò∞
                    </button>
                    <ul class="nav-links" id="navLinks">
                        <li><a href="auto-plac-mirko (1).html#pocetna">Poƒçetna</a></li>
                        <li><a href="auto-plac-mirko (1).html#usluge">Usluge</a></li>
                        <li><a href="auto-plac-mirko (1).html#o-nama">O nama</a></li>
                        <li><a href="kontakt.html">Kontakt</a></li>
                        <li><a href="radio.html">Radio</a></li>
                        <li id="katalogDropdownLi" style="position:relative;">
                            <a href="katalog.html" id="katalogLink">Katalog</a>
                            <ul id="katalogDropdown" style="display:none;position:absolute;top:100%;left:0;background:#fff;min-width:180px;box-shadow:0 4px 16px rgba(0,0,0,0.13);border-radius:7px;padding:8px 0;z-index:1001;list-style:none;">
                                <li id="dodajOglasDropdownLi" style="display:none;"><a href="#" id="dodajOglasDropdown" style="display:block;padding:10px 22px;color:#2c3e50;text-decoration:none;font-weight:500;">Dodaj oglas</a></li>
                            </ul>
                        </li>
                        <li id="loginNavLi"><button id="loginBtn" onclick="window.location.href='login.html'" style="background:#e74c3c;color:white;border:none;padding:6px 16px;border-radius:5px;cursor:pointer;font-size:15px;">Log In</button></li>
                        <li id="logoutNavLi" style="display:none;"><button id="logoutBtn" onclick="localStorage.removeItem('apm_admin');window.location.reload();" style="background:#333;color:white;border:none;padding:6px 16px;border-radius:5px;cursor:pointer;font-size:15px;">Log Out</button></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <main class="main-content">
        <section class="section">
            <div class="container">
                <div class="section-title">
                    <h2>Katalog vozila</h2>
                    <div id="addCarBtnWrap" style="margin:30px 0 0 0; text-align:center; display:none;">
                        <button id="showAddCarBtn" style="background:#e74c3c;color:white;border:none;padding:14px 38px;border-radius:7px;cursor:pointer;font-size:1.2rem;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-right:15px;">Dodaj oglas</button>
                        <button id="importCarBtn" style="background:#27ae60;color:white;border:none;padding:14px 38px;border-radius:7px;cursor:pointer;font-size:1.2rem;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.08);">Importuj auto</button>
                    </div>
                </div>
                <div class="search-container" style="display:flex;justify-content:center;margin-bottom:36px;">
                    <input id="searchBar" type="text" placeholder="Pretra≈æi po modelu..." style="padding:12px 20px;font-size:1.1rem;border:1px solid #ccc;border-radius:4px 0 0 4px;outline:none;width:300px;">
                    <button onclick="searchCatalog()" style="padding:12px 25px;font-size:1.1rem;border:none;background:#e74c3c;color:white;border-radius:0 4px 4px 0;cursor:pointer;transition:background 0.2s;">Pretra≈æi</button>
                </div>
                <div class="catalog-grid" id="catalogGrid">
                    <!-- Automobili ƒáe biti prikazani ovde -->
                </div>
                <!-- Modal for car details and image slider -->
                <div id="carModalOverlay" style="display:none;position:fixed;z-index:2100;top:0;left:0;width:100vw;height:100vh;background:rgba(44,62,80,0.55);backdrop-filter:blur(2px);justify-content:center;align-items:center;">
                  <div id="carModalPanel" style="position:relative;background:#fff;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,0.18);padding:18px 18px 8px 18px;max-width:950px;width:99vw;max-height:97vh;overflow-y:auto;display:flex;flex-direction:column;gap:0;">
                    <button id="closeCarModalBtn" style="position:absolute;top:10px;right:10px;background:transparent;border:none;font-size:1.7rem;color:#e74c3c;cursor:pointer;z-index:10;">&times;</button>
                    <div id="carModalContent"></div>
                  </div>
                </div>
                <!-- Improved Modal Overlay for Admin Add Form -->
                <div id="adminModalOverlay" class="modal-overlay">
                  <div id="adminPanel" class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="addCarTitle">
                    <div class="modal-panel-header">
                        <h2 id="addCarTitle">Dodaj novo vozilo</h2>
                        <p>Popunite kljuƒçne podatke i otpremite slike</p>
                        <button id="closeAdminPanelBtn" class="modal-close-btn" aria-label="Zatvori">&times;</button>
                    </div>
                    <form id="addCarForm" class="admin-form-body" novalidate>
                        <!-- Storage status sekcija uklonjena -->
                        <div class="admin-form-grid">
                            <div class="form-group form-row-span file-input-wrap">
                                <label for="carImages">Slike vozila</label>
                                <div class="file-picker">
                                    <button type="button" id="carImagesTrigger" class="file-trigger-btn">Izaberi slike vozila</button>
                                    <span id="carImagesInfo" class="file-info">Nijedna slika nije izabrana</span>
                                </div>
                                <input type="file" id="carImages" class="hidden-file-input" accept="image/*" multiple />
                            </div>
                            <div class="form-group form-row-span">
                                <label for="carImageUrls">ALTERNATIVNO: URL linkovi slika (jedan po liniji)</label>
                                <textarea id="carImageUrls" placeholder="https://slika1.jpg&#10;https://slika2.jpg&#10;https://slika3.jpg" style="min-height:80px;"></textarea>
                                <div class="input-hint">üí° Unesite linkove ka slikama (NEOGRANIƒåEN BROJ) - mnogo manje tro≈°i prostor!</div>
                            </div>
                            <div class="form-group">
                                <label for="carModel">Marka i model</label>
                                <input type="text" id="carModel" required placeholder="npr. Audi A4" />
                            </div>
                            <div class="form-group">
                                <label for="carKm">Kilometra≈æa</label>
                                <input type="number" id="carKm" min="0" required placeholder="npr. 184500" />
                            </div>
                            <div class="form-group">
                                <label for="carYear">Godi≈°te</label>
                                <input type="text" id="carYear" required placeholder="npr. 2017" />
                            </div>
                            <div class="form-group">
                                <label for="carKw">JAƒåINA MOTORA (KW)</label>
                                <input type="number" id="carKw" min="1" step="1" required placeholder="npr. 80" />
                                <div class="input-hint" id="kwToKsHint">= 0 KS</div>
                            </div>
                            <div class="form-group">
                                <label for="carEngine">Motor</label>
                                <input type="text" id="carEngine" placeholder="npr. 2.0 TDI, BKC, D4HF..." />
                            </div>
                            <div class="form-group">
                                <label for="carFuel">VRSTA GORIVA</label>
                                <select id="carFuel" required>
                                    <option value="">-- Izaberite --</option>
                                    <option value="Benzin">Benzin</option>
                                    <option value="Dizel">Dizel</option>
                                    <option value="Benzin + Gas (TNG)">Benzin + Gas (TNG)</option>
                                    <option value="Metan (CNG)">Metan (CNG)</option>
                                    <option value="Hibrid (Benzin)">Hibrid (Benzin)</option>
                                    <option value="Hibrid (Dizel)">Hibrid (Dizel)</option>
                                    <option value="Plug-in Hibrid">Plug-in Hibrid</option>
                                    <option value="Elektriƒçni">Elektriƒçni</option>
                                    <option value="Benzin + Etanol (E85)">Benzin + Etanol (E85)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="carPrice">Cena (‚Ç¨)</label>
                                <input type="text" id="carPrice" required placeholder="npr. 12.500" />
                            </div>
                            <div class="form-group form-row-span">
                                <label for="carDesc">Dodatne informacije</label>
                                <textarea id="carDesc" placeholder="Servisna istorija, oprema, stanje..."></textarea>
                            </div>
                        </div>
                        <div class="divider-line"></div>
                        <div class="submit-bar">
                            <button type="submit" id="submitCarBtn" class="primary-btn">Objavi vozilo</button>
                            <!-- Optimizuj prostor dugme uklonjeno -->
                        </div>
                    </form>
                  </div>
                </div>

                <!-- Import Modal -->
                <div id="importModalOverlay" class="modal-overlay" style="display:none;">
                  <div class="modal-panel" style="max-width:600px;width:90vw;">
                    <div class="modal-panel-header" style="background:linear-gradient(120deg,#27ae60,#2ecc71);">
                      <h2>Importuj vozilo</h2>
                      <p>Unesite URL oglasa sa Polovni Automobili</p>
                      <button id="closeImportModalBtn" class="modal-close-btn">&times;</button>
                    </div>
                    <div class="form-body" style="padding:30px;">
                      <div class="form-group">
                        <label for="importUrl" style="font-weight:600;margin-bottom:8px;display:block;color:#2c3e50;">URL oglasa</label>
                        <input type="url" id="importUrl" placeholder="https://www.polovniautomobili.com/auto-oglasi/..." style="width:100%;padding:12px;border:2px solid #ecf0f1;border-radius:8px;font-size:1rem;transition:border-color 0.3s;"/>
                        <small style="color:#7f8c8d;margin-top:5px;display:block;">Kopirajte link oglasa sa polovniautomobili.com</small>
                      </div>
                      <div id="importStatus" style="margin:20px 0;padding:15px;border-radius:8px;display:none;"></div>
                      <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:30px;">
                        <button type="button" id="cancelImportBtn" style="padding:12px 25px;border:2px solid #bdc3c7;background:transparent;color:#7f8c8d;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;">Otka≈æi</button>
                        <button type="button" id="startImportBtn" style="padding:12px 25px;background:#27ae60;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;">Importuj</button>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
        </section>
    </main>
    <footer><!-- Single footer (duplikat uklonjen) -->
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3 onclick="window.location.href='auto-plac-mirko (1).html'" style="cursor:pointer;">Auto Plac Mirko</h3>
                    <p>Va≈° pouzdani partner za kvalitetna polovna vozila i profesionalne automobilske usluge u Prokuplju.</p>
                </div>
                <div class="footer-section">
                    <h3>Usluge</h3>
                    <p>Prodaja polovnih vozila<br />Vulkanizerske usluge<br />Dijagostika<br />Tehniƒçki pregledi</p>
                </div>
                <div class="footer-section">
                    <h3>Kontakt</h3>
                    <p>Prokuplje, Srbija<br /></p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Auto Plac Mirko. Sva prava zadr≈æana. Dizajnirano od strane VelByte!</p>
            </div>
        </div>
    </footer>
    <script>
    // Prikaz i ƒçuvanje vozila u localStorage
    function isAdmin() {
        return localStorage.getItem('apm_admin') === '1';
    }
    
    // Debug funkcije za testiranje - pozovite u browser console
    function testAdminSystem() {
        console.log('üîç TEST ADMIN SISTEMA:');
        console.log('1. isAdmin():', isAdmin());
        console.log('2. localStorage apm_admin:', localStorage.getItem('apm_admin'));
        
        const addCarBtnWrap = document.getElementById('addCarBtnWrap');
        const dodajOglasDropdownLi = document.getElementById('dodajOglasDropdownLi');
        
        console.log('3. addCarBtnWrap element:', !!addCarBtnWrap);
        if (addCarBtnWrap) {
            console.log('4. addCarBtnWrap display:', addCarBtnWrap.style.display);
            console.log('5. addCarBtnWrap computed style:', window.getComputedStyle(addCarBtnWrap).display);
        }
        
        console.log('6. dodajOglasDropdownLi element:', !!dodajOglasDropdownLi);
        if (dodajOglasDropdownLi) {
            console.log('7. dodajOglasDropdownLi display:', dodajOglasDropdownLi.style.display);
            console.log('8. dodajOglasDropdownLi computed style:', window.getComputedStyle(dodajOglasDropdownLi).display);
        }
        
        console.log('üí° Dostupne komande:');
        console.log('‚Ä¢ forceHideAdminButtons() - prisilno sakrij admin dugmad');
        console.log('‚Ä¢ forceShowAdminButtons() - prisilno prika≈æi admin dugmad');
        console.log('‚Ä¢ clearAdminStatus() - obri≈°i admin status');
    }
    
    function forceHideAdminButtons() {
        const addCarBtnWrap = document.getElementById('addCarBtnWrap');
        const dodajOglasDropdownLi = document.getElementById('dodajOglasDropdownLi');
        
        if (addCarBtnWrap) {
            addCarBtnWrap.style.display = 'none';
            addCarBtnWrap.style.visibility = 'hidden';
            addCarBtnWrap.style.height = '0';
            addCarBtnWrap.style.overflow = 'hidden';
        }
        
        if (dodajOglasDropdownLi) {
            dodajOglasDropdownLi.style.display = 'none';
        }
        
        console.log('‚úÖ Admin dugmad prisilno sakrivena');
    }
    
    function forceShowAdminButtons() {
        const addCarBtnWrap = document.getElementById('addCarBtnWrap');
        const dodajOglasDropdownLi = document.getElementById('dodajOglasDropdownLi');
        
        if (addCarBtnWrap) {
            addCarBtnWrap.style.display = '';
            addCarBtnWrap.style.visibility = '';
            addCarBtnWrap.style.height = '';
            addCarBtnWrap.style.overflow = '';
        }
        
        if (dodajOglasDropdownLi) {
            dodajOglasDropdownLi.style.display = '';
        }
        
        console.log('‚úÖ Admin dugmad prisilno prikazana');
    }
    
    function clearAdminStatus() {
        localStorage.removeItem('apm_admin');
        console.log('‚úÖ Admin status obrisan');
        window.location.reload();
    }

    // Helper funkcije za zakljuƒçavanje / otkljuƒçavanje skrola
    function lockScroll(){ document.body.classList.add('no-scroll'); }
    function unlockScroll(){ document.body.classList.remove('no-scroll'); }

    // AI funkcija za klasifikaciju slika automobila
    function analyzeCarImage(imageData) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // Analiza boja i regiona slike
                const imageDataPixels = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageDataPixels.data;
                
                // Analiziraj razliƒçite regione slike
                const analysis = {
                    brightness: calculateBrightness(pixels),
                    colorVariance: calculateColorVariance(pixels),
                    edgeContent: calculateEdgeContent(pixels, canvas.width, canvas.height),
                    verticalLines: detectVerticalLines(pixels, canvas.width, canvas.height),
                    horizontalLines: detectHorizontalLines(pixels, canvas.width, canvas.height),
                    darkRegions: calculateDarkRegions(pixels),
                    metallic: detectMetallicSurfaces(pixels),
                    leather: detectLeatherTextures(pixels),
                    glass: detectGlassReflections(pixels)
                };
                
                // AI klasifikacija na osnovu analize
                const classification = classifyCarImage(analysis);
                
                resolve({
                    type: classification.type,
                    confidence: classification.confidence,
                    quality: calculateImageQuality(analysis),
                    analysis: analysis
                });
            };
            img.src = imageData;
        });
    }

    // Funkcije za analizu slika
    function calculateBrightness(pixels) {
        let total = 0;
        for (let i = 0; i < pixels.length; i += 4) {
            total += (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;
        }
        return total / (pixels.length / 4);
    }

    function calculateColorVariance(pixels) {
        const colors = [];
        for (let i = 0; i < pixels.length; i += 16) { // Sampleuj svaki 4. piksel
            colors.push({
                r: pixels[i],
                g: pixels[i + 1],
                b: pixels[i + 2]
            });
        }
        
        // Izraƒçunaj varijansu boja
        let rVar = 0, gVar = 0, bVar = 0;
        const avgR = colors.reduce((sum, c) => sum + c.r, 0) / colors.length;
        const avgG = colors.reduce((sum, c) => sum + c.g, 0) / colors.length;
        const avgB = colors.reduce((sum, c) => sum + c.b, 0) / colors.length;
        
        colors.forEach(c => {
            rVar += Math.pow(c.r - avgR, 2);
            gVar += Math.pow(c.g - avgG, 2);
            bVar += Math.pow(c.b - avgB, 2);
        });
        
        return (rVar + gVar + bVar) / (colors.length * 3);
    }

    function calculateEdgeContent(pixels, width, height) {
        let edgeCount = 0;
        const threshold = 30;
        
        for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
                const idx = (y * width + x) * 4;
                const currentBrightness = (pixels[idx] + pixels[idx + 1] + pixels[idx + 2]) / 3;
                
                // Proveri susedne piksele
                const rightIdx = (y * width + x + 1) * 4;
                const bottomIdx = ((y + 1) * width + x) * 4;
                
                const rightBrightness = (pixels[rightIdx] + pixels[rightIdx + 1] + pixels[rightIdx + 2]) / 3;
                const bottomBrightness = (pixels[bottomIdx] + pixels[bottomIdx + 1] + pixels[bottomIdx + 2]) / 3;
                
                if (Math.abs(currentBrightness - rightBrightness) > threshold ||
                    Math.abs(currentBrightness - bottomBrightness) > threshold) {
                    edgeCount++;
                }
            }
        }
        
        return edgeCount / (width * height);
    }

    function detectVerticalLines(pixels, width, height) {
        let verticalScore = 0;
        
        // Analiza vertikalnih linija (tipiƒçno za boƒçne strane automobila)
        for (let x = 0; x < width; x += 10) {
            let consistency = 0;
            for (let y = 10; y < height - 10; y++) {
                const idx1 = (y * width + x) * 4;
                const idx2 = ((y + 5) * width + x) * 4;
                
                const brightness1 = (pixels[idx1] + pixels[idx1 + 1] + pixels[idx1 + 2]) / 3;
                const brightness2 = (pixels[idx2] + pixels[idx2 + 1] + pixels[idx2 + 2]) / 3;
                
                if (Math.abs(brightness1 - brightness2) < 20) {
                    consistency++;
                }
            }
            verticalScore += consistency / (height / 5);
        }
        
        return verticalScore / (width / 10);
    }

    function detectHorizontalLines(pixels, width, height) {
        let horizontalScore = 0;
        
        // Analiza horizontalnih linija (tipiƒçno za prednji/zadnji deo)
        for (let y = 0; y < height; y += 10) {
            let consistency = 0;
            for (let x = 10; x < width - 10; x++) {
                const idx1 = (y * width + x) * 4;
                const idx2 = (y * width + x + 5) * 4;
                
                const brightness1 = (pixels[idx1] + pixels[idx1 + 1] + pixels[idx1 + 2]) / 3;
                const brightness2 = (pixels[idx2] + pixels[idx2 + 1] + pixels[idx2 + 2]) / 3;
                
                if (Math.abs(brightness1 - brightness2) < 20) {
                    consistency++;
                }
            }
            horizontalScore += consistency / (width / 5);
        }
        
        return horizontalScore / (height / 10);
    }

    function calculateDarkRegions(pixels) {
        let darkPixels = 0;
        for (let i = 0; i < pixels.length; i += 4) {
            const brightness = (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;
            if (brightness < 80) {
                darkPixels++;
            }
        }
        return darkPixels / (pixels.length / 4);
    }

    function detectMetallicSurfaces(pixels) {
        let metallicScore = 0;
        
        for (let i = 0; i < pixels.length; i += 40) {
            const r = pixels[i];
            const g = pixels[i + 1];
            const b = pixels[i + 2];
            
            // Metalne povr≈°ine imaju sliƒçnu RGB vrednost sa visokim reflektovanjem
            const similarity = 1 - (Math.abs(r - g) + Math.abs(g - b) + Math.abs(r - b)) / (3 * 255);
            const brightness = (r + g + b) / 3;
            
            if (similarity > 0.8 && brightness > 100) {
                metallicScore++;
            }
        }
        
        return metallicScore / (pixels.length / 160);
    }

    function detectLeatherTextures(pixels) {
        let leatherScore = 0;
        
        for (let i = 0; i < pixels.length; i += 40) {
            const r = pixels[i];
            const g = pixels[i + 1];
            const b = pixels[i + 2];
            
            // Ko≈æa ima specifiƒçne braon/be≈æ tonove
            if ((r > g && r > b && r - g < 50 && r - b > 20) || // braon tonovi
                (r > 180 && g > 160 && b > 140 && r - b < 40)) { // be≈æ tonovi
                leatherScore++;
            }
        }
        
        return leatherScore / (pixels.length / 160);
    }

    function detectGlassReflections(pixels) {
        let glassScore = 0;
        let highBrightness = 0;
        
        for (let i = 0; i < pixels.length; i += 4) {
            const brightness = (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;
            if (brightness > 200) {
                highBrightness++;
            }
        }
        
        // Staklo ima visoke refleksije (svetle oblasti)
        return highBrightness / (pixels.length / 4);
    }

    function calculateImageQuality(analysis) {
        // Kombinuj razliƒçite faktore za ocenu kvaliteta
        const edgeQuality = Math.min(analysis.edgeContent * 100, 100);
        const colorQuality = Math.min(analysis.colorVariance / 10, 100);
        const brightnessQuality = 100 - Math.abs(analysis.brightness - 128) / 1.28;
        
        return (edgeQuality + colorQuality + brightnessQuality) / 3;
    }

    function classifyCarImage(analysis) {
        const scores = {
            exterior_front: 0,
            exterior_side: 0,
            exterior_rear: 0,
            interior: 0,
            detail: 0,
            general: 0
        };
        
        // Eksterijer prednji deo - horizontalne linije, metalne povr≈°ine
        scores.exterior_front = (analysis.horizontalLines * 40) + 
                               (analysis.metallic * 30) + 
                               (analysis.glass * 20) +
                               (analysis.edgeContent * 10);
        
        // Eksterijer boƒçni deo - vertikalne linije, metalne povr≈°ine
        scores.exterior_side = (analysis.verticalLines * 50) + 
                              (analysis.metallic * 30) + 
                              (analysis.edgeContent * 20);
        
        // Eksterijer zadnji deo - horizontalne linije, manje stakla
        scores.exterior_rear = (analysis.horizontalLines * 40) + 
                              (analysis.metallic * 30) + 
                              (analysis.edgeContent * 20) +
                              (analysis.glass * 10);
        
        // Enterijer - ko≈æa, tamnije oblasti, manje metalnih povr≈°ina
        scores.interior = (analysis.leather * 50) + 
                         (analysis.darkRegions * 30) + 
                         (analysis.metallic * -10) + // manje metala u enterijeru
                         (analysis.colorVariance * 20);
        
        // Detalj - visok edge content, fokus na specifiƒçnu oblast
        scores.detail = (analysis.edgeContent * 60) + 
                       (analysis.colorVariance * 40);
        
        // Op≈°te - proseƒçne vrednosti
        scores.general = (analysis.brightness / 128 * 30) + 
                        (analysis.colorVariance * 20) + 
                        (analysis.edgeContent * 30) +
                        (analysis.quality * 20);
        
        // Pronaƒëi najveƒái skor
        let maxType = 'general';
        let maxScore = scores.general;
        
        for (const [type, score] of Object.entries(scores)) {
            if (score > maxScore) {
                maxScore = score;
                maxType = type;
            }
        }
        
        return {
            type: maxType,
            confidence: Math.min(maxScore / 100, 1)
        };
    }

    // Funkcija za kompresiju slika
    function compressImage(file, maxWidth, maxHeight, quality) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Izraƒçunaj nove dimenzije zadr≈æavajuƒái proporcije
                let { width, height } = img;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Crtaj kompresovanu sliku
                ctx.drawImage(img, 0, 0, width, height);
                
                // Konvertuj u base64 sa kvalitetom
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedBase64);
            };
            
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }

    // AI funkcija za inteligentnu selekciju slika
    async function selectBestImages(files) {
        console.log(`ü§ñ AI analizira ${files.length} slika...`);
        
        if (files.length <= 8) {
            console.log(`Manje od 8 slika - koristim sve`);
            return Array.from(files);
        }
        
        const analyzedImages = [];
        
        // Analiziraj sve slike
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            try {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const tempImg = new Image();
                
                const analysis = await new Promise((resolve) => {
                    tempImg.onload = async function() {
                        tempCanvas.width = tempImg.width;
                        tempCanvas.height = tempImg.height;
                        tempCtx.drawImage(tempImg, 0, 0);
                        
                        const imageData = tempCanvas.toDataURL('image/jpeg', 1.0);
                        const result = await analyzeCarImage(imageData);
                        resolve(result);
                    };
                    tempImg.src = URL.createObjectURL(file);
                });
                
                analyzedImages.push({
                    file: file,
                    analysis: analysis,
                    index: i
                });
                
                console.log(`üìä Slika ${i+1}: ${analysis.type} (kvalitet: ${analysis.quality.toFixed(1)})`);
                
            } catch (error) {
                console.error(`Gre≈°ka pri analizi slike ${i+1}:`, error);
                // Dodaj bez analize ako analiza ne uspe
                analyzedImages.push({
                    file: file,
                    analysis: { type: 'general', quality: 50, confidence: 0.5 },
                    index: i
                });
            }
        }
        
        // Grupi≈°i slike po tipovima
        const categories = {
            exterior_front: [],
            exterior_side: [],
            exterior_rear: [],
            interior: [],
            detail: [],
            general: []
        };
        
        analyzedImages.forEach(img => {
            const type = img.analysis.type || 'general';
            if (categories[type]) {
                categories[type].push(img);
            } else {
                categories.general.push(img);
            }
        });
        
        // Sortiraj svaku kategoriju po kvalitetu
        Object.keys(categories).forEach(key => {
            categories[key].sort((a, b) => (b.analysis.quality || 0) - (a.analysis.quality || 0));
        });
        
        // Izaberi VI≈†E slika iz svake kategorije (neograniƒçena selekcija)
        const selectedImages = [];
        
        // SVE najbolje sa prednje strane (do 10)
        if (categories.exterior_front.length > 0) {
            selectedImages.push(...categories.exterior_front.slice(0, 10));
        }
        
        // SVE najbolje sa boƒçnih strana (do 10)
        if (categories.exterior_side.length > 0) {
            selectedImages.push(...categories.exterior_side.slice(0, 10));
        }
        
        // SVE najbolje sa zadnje strane (do 8)
        if (categories.exterior_rear.length > 0) {
            selectedImages.push(...categories.exterior_rear.slice(0, 8));
        }
        
        // SVE najbolje iz enterijera (do 10)
        if (categories.interior.length > 0) {
            selectedImages.push(...categories.interior.slice(0, 10));
        }
        
        // SVE najbolje detalje (do 5)
        if (categories.detail.length > 0) {
            selectedImages.push(...categories.detail.slice(0, 5));
        }
        
        // Dodaj i sve ostale dobre slike
        const remaining = analyzedImages
            .filter(img => !selectedImages.includes(img))
            .sort((a, b) => (b.analysis.quality || 0) - (a.analysis.quality || 0));
        
        selectedImages.push(...remaining);
        
        // Finalna selekcija - sortiraj po kvalitetu (NEOGRANIƒåENO)
        const finalSelection = selectedImages
            .sort((a, b) => (b.analysis.quality || 0) - (a.analysis.quality || 0));
        
        console.log(`‚úÖ AI izabrao ${finalSelection.length} slika (NEOGRANIƒåENO):`);
        finalSelection.forEach((img, index) => {
            const type = img.analysis.type || 'general';
            const quality = img.analysis.quality || 0;
            console.log(`  ${index+1}. ${type} (kvalitet: ${quality.toFixed(1)})`);
        });
        
        return finalSelection.map(img => img.file);
    }

    // Funkcija za proveru veliƒçine localStorage-a
    function getLocalStorageSize() {
        let total = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                total += localStorage[key].length + key.length;
            }
        }
        return total;
    }

    // Funkcija za ƒçi≈°ƒáenje najstarijih vozila
    function cleanOldCars(targetCount = 10) {
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        if (cars.length > targetCount) {
            const recentCars = cars.slice(0, targetCount);
            localStorage.setItem('cars', JSON.stringify(recentCars));
            console.log(`Oƒçi≈°ƒáeno: zadr≈æano ${targetCount} najnovijih vozila od ukupno ${cars.length}`);
            return true;
        }
        return false;
    }

    // Funkcija za optimizaciju postojeƒáih slika
    function optimizeExistingImages() {
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let optimized = false;
        
        cars.forEach(car => {
            // Samo proveri da li postoje slike - nema vi≈°e ograniƒçenja
            if (car.images && Array.isArray(car.images)) {
                // Ne ograniƒçavaj broj slika
                console.log(`Vozilo "${car.model}" ima ${car.images.length} slika (zadr≈æano sve)`);
            }
        });
        
        // Nema potrebe za optimizacijom jer nema ograniƒçenja
        return false;
    }

    // Funkcija za a≈æuriranje storage statusa
    function updateStorageStatus() {
        const storageSize = getLocalStorageSize();
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        const maxSize = 5 * 1024 * 1024; // ~5MB proseƒçan limit
        const usagePercent = ((storageSize / maxSize) * 100).toFixed(1);
        
        const sizeSpan = document.getElementById('storageSize');
        const countSpan = document.getElementById('carCount');
        
        if (sizeSpan) {
            sizeSpan.innerHTML = `Kori≈°ƒáeno: ${(storageSize / 1024).toFixed(1)} KB (~${usagePercent}%)`;
            if (usagePercent > 80) {
                sizeSpan.style.color = '#e74c3c';
            } else if (usagePercent > 60) {
                sizeSpan.style.color = '#f39c12';
            } else {
                sizeSpan.style.color = '#27ae60';
            }
        }
        
        if (countSpan) {
            countSpan.textContent = `Broj vozila: ${cars.length}`;
        }
    }

    function openAdminModal() {
        const overlay = document.getElementById('adminModalOverlay');
        if(!overlay) return;
        lockScroll();
        overlay.style.display = 'flex';
        overlay.style.animation = 'fadeIn .35s ease forwards';
        const panel = document.getElementById('adminPanel');
        if(panel){
            panel.style.opacity = '0';
            requestAnimationFrame(()=>{
                panel.style.transition = 'opacity .4s ease';
                panel.style.opacity = '1';
                panel.setAttribute('tabindex','-1');
                panel.focus();
            });
        }
        
        // A≈æuriraj storage status kad se otvori modal
        // updateStorageStatus(); // uklonjeno
    }
    function closeAdminModal() {
        const overlay = document.getElementById('adminModalOverlay');
        if(!overlay) return;
        const panel = document.getElementById('adminPanel');
        if(panel) panel.style.opacity = '0';
        overlay.style.animation = 'fadeOut .3s ease forwards';
        setTimeout(()=>{ overlay.style.display='none'; unlockScroll(); }, 280);
        const wrap = document.getElementById('addCarBtnWrap');
        if(wrap) wrap.style.display = '';
    }

    // Import modal functions
    function openImportModal() {
        const overlay = document.getElementById('importModalOverlay');
        if(!overlay) return;
        lockScroll();
        overlay.style.display = 'flex';
        overlay.style.animation = 'fadeIn .3s ease forwards';
        // Clear previous data
        document.getElementById('importUrl').value = '';
        hideImportStatus();
    }

    function closeImportModal() {
        const overlay = document.getElementById('importModalOverlay');
        if(!overlay) return;
        overlay.style.animation = 'fadeOut .3s ease forwards';
        setTimeout(()=>{ overlay.style.display='none'; unlockScroll(); }, 280);
    }

    function showImportStatus(message, type = 'info') {
        const statusDiv = document.getElementById('importStatus');
        const colors = {
            'info': '#3498db',
            'success': '#27ae60',
            'error': '#e74c3c',
            'warning': '#f39c12'
        };
        statusDiv.style.display = 'block';
        statusDiv.style.backgroundColor = colors[type] + '20';
        statusDiv.style.borderLeft = '4px solid ' + colors[type];
        statusDiv.style.color = colors[type];
        statusDiv.innerHTML = message;
        
        // Add retry button for errors
        if (type === 'error') {
            statusDiv.innerHTML += '<br><br><button onclick="retryImport()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Poku≈°aj ponovo</button>';
        }
    }

    function retryImport() {
        hideImportStatus();
        setTimeout(() => {
            startImport();
        }, 100);
    }

    function hideImportStatus() {
        document.getElementById('importStatus').style.display = 'none';
    }

    // Main import function
    async function startImport() {
        const url = document.getElementById('importUrl').value.trim();
        const startBtn = document.getElementById('startImportBtn');
        
        if (!url) {
            showImportStatus('Molimo unesite URL oglasa', 'error');
            return;
        }

        if (!url.includes('polovniautomobili.com')) {
            showImportStatus('URL mora biti sa sajta polovniautomobili.com', 'error');
            return;
        }

        // Disable button and show loading
        startBtn.disabled = true;
        startBtn.textContent = 'Importujem...';
        showImportStatus('Analiziram oglas... Povlaƒçim taƒçne podatke sa stranice.', 'info');

        try {
            // Try real scraping first using CORS proxy
            await realImport(url);
        } catch (error) {
            console.error('Import error:', error);
            
            // Provide more helpful error messages based on error type
            let errorMessage = 'Gre≈°ka prilikom importa: ' + error.message;
            
            if (error.message.includes('proxy') || error.message.includes('CORS') || error.message.includes('blokirani')) {
                errorMessage = `
                    <strong>Gre≈°ka prilikom importa:</strong> ${error.message}<br><br>
                    <strong>Razlog:</strong> Svi CORS proxy servisi su trenutno nedostupni ili blokirani.<br><br>
                    <strong>Re≈°enja:</strong><br>
                    1. <strong>Jednostavno:</strong> Kopiraj URL, otvori u novom tabu i ruƒçno prepi≈°i podatke<br>
                    2. <strong>Automatsko:</strong> Ako URL sadr≈æi marku/model, klikni ponovo - sistem ƒáe poku≈°ati da izvuƒçe osnovne podatke<br>
                    3. <strong>Tehniƒçno:</strong> Instaliraj CORS browser ekstenziju (npr. "CORS Unblock")<br>
                    4. <strong>Alternativa:</strong> Poku≈°aj ponovo za 5-10 minuta - proxy servisi se ƒçesto vraƒáaju<br><br>
                    <em>Napomena: Ovo je tehniƒçka ograniƒçenost browsera, ne gre≈°ka sajta.</em>
                `;
            }
            
            showImportStatus(errorMessage, 'error');
        } finally {
            startBtn.disabled = false;
            startBtn.textContent = 'Importuj';
        }
    }

    // Real import function that attempts to scrape actual data
    async function realImport(url) {
        showImportStatus('Poku≈°avam da pristupim stranici...', 'info');
        
        // Method 1: Try CORS proxy services - expanded list with more alternatives
        const corsProxies = [
            { url: 'https://api.allorigins.win/get?url=', type: 'json' },
            { url: 'https://cors-anywhere.herokuapp.com/', type: 'text' },
            { url: 'https://thingproxy.freeboard.io/fetch/', type: 'text' },
            { url: 'https://api.codetabs.com/v1/proxy?quest=', type: 'text' },
            { url: 'https://yacdn.org/proxy/', type: 'text' },
            { url: 'https://cors.bridged.cc/', type: 'text' },
            { url: 'https://api.1337x.unblocker.cc/', type: 'text' }
        ];

        let extractedData = null;
        
        for (let i = 0; i < corsProxies.length; i++) {
            try {
                showImportStatus(`Poku≈°avam proxy ${i + 1}/${corsProxies.length}...`, 'info');
                
                const proxy = corsProxies[i];
                const proxyUrl = proxy.url + encodeURIComponent(url);
                
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                let html;
                if (proxy.type === 'json' || proxy.url.includes('allorigins')) {
                    const data = await response.json();
                    html = data.contents;
                } else {
                    html = await response.text();
                }
                
                // Check if we actually got HTML content
                if (!html || html.length < 100 || !html.includes('<')) {
                    throw new Error('Neva≈æeƒái HTML sadr≈æaj');
                }
                
                showImportStatus('Analiziram HTML sadr≈æaj stranice...', 'info');
                extractedData = await parseHalfCarHTML(html, url);
                
                if (extractedData && extractedData.model) {
                    break; // Success!
                }
            } catch (error) {
                console.log(`Proxy ${i + 1} failed:`, error);
                if (i === corsProxies.length - 1) {
                    // If all proxies fail, try a different approach
                    showImportStatus('Svi proxy servisi su blokirani. Poku≈°avam alternativni pristup...', 'warning');
                    return await fallbackImport(url);
                }
            }
        }

        if (!extractedData || !extractedData.model) {
            throw new Error('Nisu pronaƒëeni podaci o vozilu na datoj stranici');
        }

        showImportStatus('Uspe≈°no povuƒçeni podaci! Popunjavam formular...', 'success');
        await new Promise(resolve => setTimeout(resolve, 300)); // Skraƒáeno sa 1000ms na 300ms

        // Fill the form with real extracted data
        fillFormWithImportedData(extractedData);
        
        // Close import modal and open add car modal
        closeImportModal();
        setTimeout(() => {
            openAdminModal();
            showImportStatus('Taƒçni podaci sa stranice su uspe≈°no importovani!', 'success');
        }, 300);
    }

    // Fallback import when all CORS proxies fail
    async function fallbackImport(url) {
        try {
            showImportStatus('Poku≈°avam da izvuƒçem podatke iz URL-a...', 'info');
            
            // Try to extract some basic info from the URL itself
            const urlData = extractDataFromUrl(url);
            
            if (urlData) {
                showImportStatus('Izvuƒçeni osnovni podaci iz URL-a. Molimo dopunite ostale informacije.', 'warning');
                
                fillFormWithImportedData(urlData);
                
                // Close import modal and open add car modal
                closeImportModal();
                setTimeout(() => {
                    openAdminModal();
                    showImportStatus('Osnovni podaci izvuƒçeni iz URL-a. Molimo proverite i dopunite podatke.', 'warning');
                }, 300);
                
                return urlData;
            } else {
                throw new Error('Nije moguƒáe pristupiti stranici. Molimo unesite podatke ruƒçno.');
            }
            
        } catch (error) {
            throw new Error('Svi pristupi su blokirani. Molimo kopirajte podatke ruƒçno sa stranice.');
        }
    }

    // Extract basic data from URL patterns (for when proxies don't work)
    function extractDataFromUrl(url) {
        try {
            // Common patterns in car listing URLs
            const urlLower = url.toLowerCase();
            
            // Basic car data object
            const data = {};
            
            // Try to extract brand and model from URL segments
            const urlSegments = url.split('/').filter(segment => segment.length > 2);
            
            // Look for common car brands in URL
            const brands = ['volkswagen', 'vw', 'audi', 'bmw', 'mercedes', 'ford', 'opel', 'peugeot', 'citroen', 'renault', 'fiat', 'skoda', 'seat', 'honda', 'toyota', 'nissan', 'mazda', 'hyundai', 'kia'];
            
            let foundBrand = '';
            let foundModel = '';
            
            for (const segment of urlSegments) {
                const segmentLower = segment.toLowerCase();
                
                // Check for brand names
                for (const brand of brands) {
                    if (segmentLower.includes(brand)) {
                        foundBrand = brand.charAt(0).toUpperCase() + brand.slice(1);
                        if (brand === 'vw') foundBrand = 'Volkswagen';
                        break;
                    }
                }
                
                // Look for year patterns
                const yearMatch = segment.match(/20(0[5-9]|1[0-9]|2[0-5])/);
                if (yearMatch && !data.year) {
                    data.year = yearMatch[0];
                }
                
                // Look for model names (common models)
                const models = ['golf', 'polo', 'passat', 'jetta', 'a3', 'a4', 'a6', 'a8', 'q3', 'q5', 'q7', '320', '520', 'x3', 'x5', 'c-class', 'e-class', 's-class', 'focus', 'fiesta', 'astra', 'corsa', '308', '208', 'c3', 'c4', 'megane', 'clio', 'punto', 'bravo', 'octavia', 'fabia', 'civic', 'accord', 'corolla', 'yaris'];
                
                for (const model of models) {
                    if (segmentLower.includes(model)) {
                        foundModel = model.charAt(0).toUpperCase() + model.slice(1);
                        break;
                    }
                }
            }
            
            if (foundBrand) {
                data.model = foundModel ? `${foundBrand} ${foundModel}` : foundBrand;
            }
            
            // Set some default values to help user
            if (!data.year) {
                data.year = '2015'; // Default reasonable year
            }
            
            return data.model ? data : null;
            
        } catch (error) {
            console.error('Error extracting from URL:', error);
            return null;
        }
    }

    // Clean car title to extract only brand and model, and extract engine info
    function cleanCarTitle(title) {
        try {
            // Remove common unwanted parts
            title = title.replace(/\s+/g, ' ').trim();
            
            // Extract engine info before cleaning (for motor field)
            const engineInfo = extractEngineFromTitle(title);
            
            // Store engine info globally so we can use it later
            window.extractedEngine = engineInfo;
            
            // Remove year patterns (more comprehensive)
            title = title.replace(/\b(19|20)\d{2}\.?\s*(god\.?|godina|godi≈°te)?\b/gi, '');
            title = title.replace(/\b(god\.?|godina|godi≈°te)\s*(19|20)\d{2}\.?\b/gi, '');
            
            // Remove engine size patterns (more comprehensive)
            title = title.replace(/\b\d+[.,]\d+\s*(l|litara?|cm3|ccm)?\b/gi, '');
            title = title.replace(/\b\d+[.,]\d+\s*(tdi|tsi|dci|hdi|cdti|d|t|i|fsi|tfsi|biturbo|turbo|dti|cdi)\b/gi, '');
            
            // Remove power/horse power patterns
            title = title.replace(/\b\d+\s*(kw|ks|hp|ps|kon|konja)\b/gi, '');
            
            // Remove fuel type mentions
            title = title.replace(/\b(dizel|benzin|hibrid|elektro|gas|tng|lng|benzin\+gas|gas\+benzin)\b/gi, '');
            
            // Remove transmission type
            title = title.replace(/\b(automatik|manual|manuelni|automatski|cvt|dsg|tiptronic|multitronic|s-tronic)\b/gi, '');
            
            // Remove trim levels and packages (more comprehensive)
            title = title.replace(/\b(comfort|comfortline|elegance|luxury|sport|sportline|s-line|m-sport|amg|rs|gti|gtd|highline|trendline|conceptline|ambition|style|design|active|dynamic|executive)\b/gi, '');
            
            // Remove body type mentions
            title = title.replace(/\b(limuzina|heƒçbek|karavan|kabriolet|coupe|kupe|suv|crossover|pickup|kombi|van)\b/gi, '');
            
            // Remove door count
            title = title.replace(/\b\d+\s*(vrata|door|dr)\b/gi, '');
            
            // Remove kilometrage mentions
            title = title.replace(/\b\d+[\.,]?\d*\s*(km|kilometara|miles)\b/gi, '');
            
            // Remove condition mentions
            title = title.replace(/\b(polovno|novo|neregistrovan|registrovan|uvoz|domaƒái|uvozno|na ime|bez kvarova)\b/gi, '');
            
            // Remove price mentions
            title = title.replace(/\b\d+[\.,]?\d*\s*(eur|‚Ç¨|din|dinara|evra)\b/gi, '');
            
            // Remove emission standards
            title = title.replace(/\beuro\s*[0-9]+\b/gi, '');
            
            // Remove drive type
            title = title.replace(/\b(4x4|awd|fwd|rwd|4wd|prednji|zadnji|pogon)\b/gi, '');
            
            // Remove extra technical specs
            title = title.replace(/\b(start\-stop|start\/stop|climate|klima|xenon|led|abs|esp|airbag|servo|centralina)\b/gi, '');
            
            // Remove extra punctuation and multiple spaces
            title = title.replace(/[,\.!;\-\+\(\)\[\]\/\\]+/g, ' ');
            title = title.replace(/\s+/g, ' ').trim();
            
            // Remove leading/trailing punctuation
            title = title.replace(/^[^\w\u0100-\u017F]+|[^\w\u0100-\u017F]+$/g, '');
            
            // If title is too short after cleaning, return original
            if (title.length < 3) {
                return title; // Return what we have
            }
            
            // Smart model extraction - only keep brand, model and generation
            const cleanTitle = extractBrandAndModel(title);
            
            return cleanTitle.trim() || title.trim();
            
        } catch (error) {
            console.error('Error cleaning title:', error);
            return title; // Return original if cleaning fails
        }
    }

    // Smart function to extract brand and model including generation numbers
    function extractBrandAndModel(title) {
        const words = title.split(' ').filter(word => word.length > 0);
        let result = '';
        
        if (words.length === 0) return title;
        
        // First word is usually the brand
        result = words[0];
        
        // Look for model pattern - be more selective
        for (let i = 1; i < words.length && i < 4; i++) { // Limit to first 4 words max
            const word = words[i];
            const lowerWord = word.toLowerCase();
            
            // Stop if we hit obvious technical specs
            if (/^\d+[.,]\d+$/.test(word)) break; // 1.6, 2.0, etc.
            if (/^(tdi|tsi|dci|hdi|cdti|tfsi|biturbo|turbo|fsi|d|t|dti|cdi)$/i.test(word)) break;
            if (/^\d+\s*(kw|ks|hp|ps)$/i.test(word)) break;
            if (/^(dizel|benzin|gas|hibrid|elektro)$/i.test(word)) break;
            
            // Include model names and generation numbers
            if (/^[a-zA-Z]+\d*$/.test(word)) {
                // Model name like Golf, Passat, A4, C220, etc.
                result += ' ' + word;
            } else if (/^\d{1,2}$/.test(word) && parseInt(word) <= 20) {
                // Generation number like 5, 6, 7, etc. (reasonable range)
                result += ' ' + word;
            } else if (/^[a-zA-Z]\-?[a-zA-Z]*$/i.test(word)) {
                // Model variants like S-Line, M-Sport (but we want to exclude these)
                // Only include simple model codes
                if (word.length <= 3 && !/(line|sport|pack)$/i.test(word)) {
                    result += ' ' + word;
                }
            }
        }
        
        return result;
    }

    // Extract engine information from car title
    function extractEngineFromTitle(title) {
        try {
            const text = title.toLowerCase();
            
            // Common engine patterns
            const enginePatterns = [
                // 1.6 TDI, 2.0 TSI, 1.4 TFSI, etc.
                /(\d+[.,]\d+)\s*(tdi|tsi|tfsi|dci|hdi|cdti|fsi|biturbo|turbo)/gi,
                // 1.6TDI (no space)
                /(\d+[.,]\d+)(tdi|tsi|tfsi|dci|hdi|cdti|fsi|biturbo|turbo)/gi,
                // Just engine size with L: 2.0L, 1.6L
                /(\d+[.,]\d+)\s*l(?!\w)/gi,
                // Engine with displacement: 1600, 2000 (for older cars)
                /\b(1[2-9]\d{2}|2\d{3})\s*(tdi|tsi|tfsi|dci|hdi|cdti|fsi)?\b/gi
            ];
            
            for (let pattern of enginePatterns) {
                const matches = title.match(pattern);
                if (matches && matches.length > 0) {
                    // Take the first match and clean it up
                    let engine = matches[0].trim();
                    
                    // Normalize the format
                    engine = engine.replace(/,/g, '.'); // Replace comma with dot
                    engine = engine.replace(/\s+/g, ' '); // Normalize spaces
                    
                    // If it's just a number like "1600", convert to "1.6"
                    const numberMatch = engine.match(/^(\d{4})$/);
                    if (numberMatch) {
                        const displacement = parseInt(numberMatch[1]);
                        const liters = (displacement / 1000).toFixed(1);
                        return liters;
                    }
                    
                    return engine;
                }
            }
            
            return null; // No engine info found
            
        } catch (error) {
            console.error('Error extracting engine:', error);
            return null;
        }
    }
    
    async function extractImagesFromPage(doc, url) {
        try {
            const images = [];
            // UKLONJEN LIMIT - sada neograniƒçeno broj slika
            // const maxImages = 15;
            
            // Look for image elements in common selectors for car sites
            const imageSelectors = [
                'img[src*="photo"]',
                'img[src*="image"]',
                'img[src*="slika"]',
                'img[alt*="auto"]',
                'img[alt*="vozilo"]',
                'img[alt*="car"]',
                '.gallery img',
                '.photos img',
                '.slike img',
                '.car-images img',
                '.vehicle-images img',
                '.photo-gallery img',
                'img[src*="polovni"]',
                'img[src*="mojaauto"]',
                'img[data-src]'
            ];
            
            const foundImages = new Set();
            
            imageSelectors.forEach(selector => {
                const imgs = doc.querySelectorAll(selector);
                imgs.forEach(img => {
                    let src = img.src || img.getAttribute('data-src') || img.getAttribute('data-lazy');
                    if (src) { // UKLONJENO: && foundImages.size < maxImages
                        // Make relative URLs absolute
                        if (src.startsWith('/')) {
                            const urlObj = new URL(url);
                            src = urlObj.origin + src;
                        } else if (!src.startsWith('http')) {
                            const urlObj = new URL(url);
                            src = urlObj.origin + '/' + src;
                        }
                        
                        // Filter out small icons and irrelevant images
                        const imgElement = img;
                        const width = imgElement.naturalWidth || parseInt(imgElement.style.width) || 0;
                        const height = imgElement.naturalHeight || parseInt(imgElement.style.height) || 0;
                        
                        // Skip very small images (likely icons)
                        if (width > 100 && height > 100) {
                            foundImages.add(src);
                        } else if (width === 0 && height === 0) {
                            // If we can't determine size, include it anyway (might be lazy loaded)
                            foundImages.add(src);
                        }
                    }
                });
            });
            
            // Return ALL URLs (neograniƒçeno)
            const imageUrls = Array.from(foundImages);
            console.log(`üîó Pronaƒëeno ${imageUrls.length} URL linkova slika (NEOGRANIƒåENO)`);
            
            return imageUrls;
            
        } catch (error) {
            console.error('Error extracting images:', error);
            return [];
        }
    }
    
    async function parseHalfCarHTML(html, url) {
        try {
            // Create a temporary DOM parser
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const data = {};
            
            console.log('Starting to parse HTML content...');
            
            // Extract title/model - specific selectors for polovniautomobili.com
            const titleSelectors = [
                'h1.classified__title', 'h1[class*="title"]', 'h1.naslov', 
                'h1', '.classified__title', '[class*="title"]', '.ad-title', 
                '.oglas-title', '[data-testid="ad-title"]', '.heading-1',
                '.title', '#title'
            ];
            
            for (let selector of titleSelectors) {
                const element = doc.querySelector(selector);
                if (element && element.textContent.trim()) {
                    let title = element.textContent.trim().replace(/\s+/g, ' ');
                    console.log('Found title:', title);
                    data.model = title; // Don't clean here, clean later
                    break;
                }
            }
            
            // Extract price - more specific selectors for polovniautomobili.com
            const priceSelectors = [
                '.classified__price', '.price__main', '.cena', '.price', 
                '[class*="cena"]', '[class*="price"]', '[data-testid="price"]', 
                '.font-bold', '.price-section', '.ad-price', '.oglas-cena',
                'span[class*="price"]', 'div[class*="price"]'
            ];
            
            for (let selector of priceSelectors) {
                const elements = doc.querySelectorAll(selector);
                for (let element of elements) {
                    const priceText = element.textContent.replace(/\s+/g, ' ');
                    console.log('Checking price text:', priceText);
                    // Look for Euro symbol or number patterns
                    const priceMatch = priceText.match(/([\d.,\s]+)\s*‚Ç¨?/) || priceText.match(/([\d.,]+)/);
                    if (priceMatch && priceMatch[1].length >= 4) {
                        const cleanPrice = priceMatch[1].replace(/[.,\s]/g, '');
                        if (cleanPrice.length >= 4 && parseInt(cleanPrice) > 1000) {
                            data.price = cleanPrice;
                            console.log('Found price:', data.price);
                            break;
                        }
                    }
                }
                if (data.price) break;
            }
            
            // Get full page text for pattern matching
            const allText = doc.body.textContent.toLowerCase();
            console.log('Full text sample:', allText.substring(0, 500));
            
            // Advanced specification extraction
            let specElements = [];
            
            // Try specific containers for polovniautomobili.com
            const specContainers = [
                '.classified__data', '.classified__info', '.vehicle-data',
                '.specifications', '.spec-table', '.data-table',
                '.osnovni-podaci', '.tehnicki-podaci', '.specifikacije',
                '.classified__specifications', '[class*="specification"]'
            ];
            
            specContainers.forEach(containerSelector => {
                const container = doc.querySelector(containerSelector);
                if (container) {
                    const elements = container.querySelectorAll('*');
                    elements.forEach(el => {
                        if (el.textContent && el.textContent.trim().length > 2) {
                            specElements.push(el);
                        }
                    });
                }
            });
            
            // If no specific containers found, try broader approach
            if (specElements.length < 10) {
                const broadSelectors = [
                    'td', 'th', 'li', 'span', 'div[class*="data"]',
                    'p', '.list-item', '.data-row', '[class*="spec"]'
                ];
                
                broadSelectors.forEach(selector => {
                    const elements = doc.querySelectorAll(selector);
                    elements.forEach(el => {
                        if (el.textContent && el.textContent.trim().length > 2) {
                            specElements.push(el);
                        }
                    });
                });
            }
            
            // Add the full page text for final pattern matching
            specElements.push({ textContent: allText });
            
            console.log(`Found ${specElements.length} spec elements to analyze`);
            
            // Process each element for data extraction
            specElements.forEach((element, index) => {
                const text = element.textContent.toLowerCase().replace(/\s+/g, ' ').trim();
                
                if (text.length < 3) return; // Skip very short texts
                
                // Year extraction - comprehensive patterns
                if (!data.year) {
                    const yearPatterns = [
                        /godi≈°te[:\s]*([12]\d{3})/,
                        /godina[:\s]*proizvodnje[:\s]*([12]\d{3})/,
                        /godina[:\s]*([12]\d{3})/,
                        /([12]\d{3})[\s]*\.?\s*god/,
                        /([12]\d{3})\s*\./,
                        /proizvodnja[:\s]*([12]\d{3})/,
                        /model[:\s]*([12]\d{3})/
                    ];
                    
                    yearPatterns.forEach(pattern => {
                        const match = text.match(pattern);
                        if (match && !data.year) {
                            const year = parseInt(match[1]);
                            if (year >= 1980 && year <= 2025) {
                                data.year = match[1];
                                console.log('Found year:', data.year);
                            }
                        }
                    });
                }
                
                // Kilometerage extraction - comprehensive patterns
                if (!data.km) {
                    const kmPatterns = [
                        /kilometra≈æa[:\s]*([\d.,\s]+)(?:\s*km)?/,
                        /preƒëeno[:\s]*([\d.,\s]+)(?:\s*km)?/,
                        /([\d.,\s]+)\s*km(?!\w)/,
                        /km[:\s]*([\d.,\s]+)/,
                        /([\d.,\s]+)\s*kilometar/,
                        /stanje[:\s]*([\d.,\s]+)\s*km/,
                        /preƒëeno\s*je[:\s]*([\d.,\s]+)/
                    ];
                    
                    kmPatterns.forEach(pattern => {
                        const match = text.match(pattern);
                        if (match && !data.km) {
                            const km = match[1].replace(/[.,\s]/g, '');
                            if (km.length >= 3 && km.length <= 7 && parseInt(km) > 0) {
                                data.km = km;
                                console.log('Found km:', data.km);
                            }
                        }
                    });
                }
                
                // Power extraction - comprehensive patterns
                if (!data.kw) {
                    const powerPatterns = [
                        /snaga\s*motora[:\s]*([\d]+)/,
                        /snaga[:\s]*([\d]+)\s*kw/,
                        /motor[:\s]*[\w\s]*?([\d]+)\s*kw/,
                        /([\d]+)\s*kw(?!\w)/,
                        /jaƒçina[:\s]*([\d]+)/,
                        /power[:\s]*([\d]+)/,
                        /snaga[:\s]*([\d]+)/
                    ];
                    
                    powerPatterns.forEach(pattern => {
                        const match = text.match(pattern);
                        if (match && !data.kw) {
                            const power = parseInt(match[1]);
                            if (power >= 30 && power <= 1000) {
                                data.kw = match[1];
                                console.log('Found kw:', data.kw);
                            }
                        }
                    });
                }
                
                // Engine size extraction - comprehensive patterns
                if (!data.engine) {
                    const enginePatterns = [
                        /motor[:\s]*([\d]+[.,]?\d*)\s*l/,
                        /kubikaza[:\s]*([\d]+[.,]?\d*)/,
                        /([\d]+[.,]?\d*)\s*l(?!\w)/,
                        /zapremina[:\s]*([\d]+[.,]?\d*)/,
                        /([\d]{4})\s*cm3/,
                        /zapremina\s*motora[:\s]*([\d]+[.,]?\d*)/
                    ];
                    
                    enginePatterns.forEach(pattern => {
                        const match = text.match(pattern);
                        if (match && !data.engine) {
                            let engine = match[1].replace(',', '.');
                            if (match[0].includes('cm3')) {
                                engine = (parseInt(engine) / 1000).toFixed(1);
                            }
                            const engineNum = parseFloat(engine);
                            if (engineNum >= 0.8 && engineNum <= 8.0) {
                                data.engine = engine;
                                console.log('Found engine:', data.engine);
                            }
                        }
                    });
                }
                
                // Fuel type extraction - comprehensive patterns with "Gorivo" label
                if (!data.fuel) {
                    // First try specific "Gorivo:" patterns for polovniautomobili.com
                    const fuelLabelPatterns = [
                        /gorivo[:\s]*(benzin.*gas|gas.*benzin)/,
                        /gorivo[:\s]*dizel/,
                        /gorivo[:\s]*benzin/,
                        /gorivo[:\s]*hibrid/,
                        /gorivo[:\s]*elektr/,
                        /gorivo[:\s]*tng/,
                        /gorivo[:\s]*lng/,
                        /gorivo[:\s]*gas/,
                        /vrsta\s*goriva[:\s]*(benzin.*gas|gas.*benzin)/,
                        /vrsta\s*goriva[:\s]*dizel/,
                        /vrsta\s*goriva[:\s]*benzin/,
                        /vrsta\s*goriva[:\s]*hibrid/,
                        /vrsta\s*goriva[:\s]*elektr/,
                        /vrsta\s*goriva[:\s]*tng/,
                        /vrsta\s*goriva[:\s]*lng/,
                        /vrsta\s*goriva[:\s]*gas/
                    ];
                    
                    fuelLabelPatterns.forEach(pattern => {
                        const match = text.match(pattern);
                        if (match && !data.fuel) {
                            const fuelText = match[0].toLowerCase();
                            if (fuelText.includes('benzin') && fuelText.includes('gas')) {
                                data.fuel = 'Benzin + Gas';
                            } else if (fuelText.includes('dizel')) {
                                data.fuel = 'Dizel';
                            } else if (fuelText.includes('benzin')) {
                                data.fuel = 'Benzin';
                            } else if (fuelText.includes('hibrid')) {
                                data.fuel = 'Hibrid';
                            } else if (fuelText.includes('elektr')) {
                                data.fuel = 'Elektro';
                            } else if (fuelText.includes('tng')) {
                                data.fuel = 'TNG';
                            } else if (fuelText.includes('lng')) {
                                data.fuel = 'LNG';
                            } else if (fuelText.includes('gas')) {
                                data.fuel = 'Gas';
                            }
                            
                            if (data.fuel) {
                                console.log('Found fuel with label:', data.fuel);
                            }
                        }
                    });
                    
                    // If no labeled fuel found, try general patterns
                    if (!data.fuel) {
                        const fuelPatterns = [
                            { pattern: /benzin.*gas|gas.*benzin/, fuel: 'Benzin + Gas' },
                            { pattern: /dizel/, fuel: 'Dizel' },
                            { pattern: /benzin/, fuel: 'Benzin' },
                            { pattern: /hibrid/, fuel: 'Hibrid' },
                            { pattern: /elektr/, fuel: 'Elektro' },
                            { pattern: /tng/, fuel: 'TNG' },
                            { pattern: /lng/, fuel: 'LNG' },
                            { pattern: /gas/, fuel: 'Gas' }
                        ];
                        
                        fuelPatterns.forEach(({ pattern, fuel }) => {
                            if (text.match(pattern) && !data.fuel) {
                                data.fuel = fuel;
                                console.log('Found fuel (general):', data.fuel);
                            }
                        });
                    }
                }
            });
            
            // Extract description
            if (!data.desc) {
                const descSelectors = [
                    '.classified__description', 
                    '.opis', 
                    '.description', 
                    '[class*="opis"]', 
                    '[class*="desc"]', 
                    '.content p', 
                    '.text-content', 
                    '.napomene', 
                    '.dodatno', 
                    '.car-description', 
                    '.ad-description',
                    '.classified-description',
                    '.listing-description',
                    '.vehicle-description',
                    '.additional-info',
                    '[data-testid="description"]',
                    '.details-description',
                    'section[class*="description"] p',
                    'div[class*="description"] p',
                    '.description-content',
                    '.description-text'
                ];
                
                for (let selector of descSelectors) {
                    const descElement = doc.querySelector(selector);
                    if (descElement && descElement.textContent.trim().length > 30) {
                        // Uzmi ceo opis bez ograniƒçavanja na 500 karaktera
                        data.desc = descElement.textContent.trim();
                        console.log('Found description:', data.desc.substring(0, 100) + '...');
                        console.log('Full description length:', data.desc.length, 'characters');
                        break;
                    }
                }
                
                // Ako nije prona≈°ao opis, poku≈°aj da kombinuje vi≈°e paragrafa
                if (!data.desc) {
                    const paragraphs = doc.querySelectorAll('p');
                    let combinedDesc = '';
                    
                    paragraphs.forEach(p => {
                        const text = p.textContent.trim();
                        // Proverava da li je paragraf dovoljno dugaƒçak i relevant–∞–Ω
                        if (text.length > 20 && 
                            !text.includes('‚Ç¨') && 
                            !text.includes('km') && 
                            !text.includes('kW') &&
                            !text.includes('Kontakt') &&
                            !text.includes('Telefon')) {
                            if (combinedDesc) combinedDesc += '\n\n';
                            combinedDesc += text;
                        }
                    });
                    
                    if (combinedDesc.length > 50) {
                        data.desc = combinedDesc;
                        console.log('Combined description from paragraphs:', data.desc.substring(0, 100) + '...');
                        console.log('Combined description length:', data.desc.length, 'characters');
                    }
                }
            }

            // Extract images from the page
            showImportStatus('Povlaƒçim slike vozila...', 'info');
            data.images = await extractImagesFromPage(doc, url);
            
            console.log(`Found ${data.images ? data.images.length : 0} images`);
            
            // Final attempts for missing data using broader patterns
            if (!data.kw || !data.km || !data.year || !data.fuel || !data.engine) {
                console.log('Trying final broader search...');
                
                // Try table extraction
                const tables = doc.querySelectorAll('table, .table, [class*="table"]');
                tables.forEach(table => {
                    const tableText = table.textContent.toLowerCase();
                    
                    if (!data.year) {
                        const yearMatch = tableText.match(/([12]\d{3})/);
                        if (yearMatch) {
                            const year = parseInt(yearMatch[1]);
                            if (year >= 1980 && year <= 2025) {
                                data.year = yearMatch[1];
                            }
                        }
                    }
                    
                    if (!data.km) {
                        const kmMatch = tableText.match(/([\d.,]+)\s*km/);
                        if (kmMatch) {
                            const km = kmMatch[1].replace(/[.,]/g, '');
                            if (km.length >= 3 && km.length <= 7) {
                                data.km = km;
                            }
                        }
                    }
                    
                    if (!data.kw) {
                        const kwMatch = tableText.match(/([\d]+)\s*kw/);
                        if (kwMatch) {
                            const power = parseInt(kwMatch[1]);
                            if (power >= 30 && power <= 1000) {
                                data.kw = kwMatch[1];
                            }
                        }
                    }
                });
            }
            
            // Clean the model title at the end after all data extraction
            if (data.model) {
                const originalTitle = data.model;
                data.model = cleanCarTitle(data.model);
                console.log('Title cleaned from:', originalTitle, 'to:', data.model);
            }
            
            console.log('Final extracted data:', data);
            
            // Debug info for troubleshooting
            showImportStatus(`Analiza zavr≈°ena. Naƒëeni podaci: ${Object.keys(data).filter(key => data[key]).length} od 7 moguƒáih`, 'info');
            
            return data;
            
        } catch (error) {
            console.error('Error parsing HTML:', error);
            throw new Error('Gre≈°ka prilikom analize HTML sadr≈æaja');
        }
    }

    function fillFormWithImportedData(data) {
        if (data.model) document.getElementById('carModel').value = data.model;
        if (data.year) document.getElementById('carYear').value = data.year;
        if (data.km) document.getElementById('carKm').value = data.km;
        if (data.kw) document.getElementById('carKw').value = data.kw;
        
        // Fill engine field - prioritize extracted engine from title, then fallback to parsed engine
        let engineValue = '';
        if (window.extractedEngine) {
            engineValue = window.extractedEngine;
        } else if (data.engine) {
            engineValue = data.engine;
        }
        if (engineValue) {
            document.getElementById('carEngine').value = engineValue;
        }
        
        if (data.fuel) document.getElementById('carFuel').value = data.fuel;
        
        // Format price with dots
        if (data.price) {
            const formattedPrice = data.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            document.getElementById('carPrice').value = formattedPrice;
        }
        
        if (data.desc) document.getElementById('carDesc').value = data.desc;
        
        // Handle imported images - use URLs directly instead of base64 with improved formatting
        if (data.images && data.images.length > 0) {
            // Set image URLs in the textarea with proper formatting
            const imageUrlsTextarea = document.getElementById('carImageUrls');
            if (imageUrlsTextarea) {
                // POBOLJ≈†ANO formatiranje - svaki URL u novom redu
                const formattedUrls = data.images
                    .map(url => url.trim())
                    .filter(url => url.length > 0)
                    .join('\n');
                
                imageUrlsTextarea.value = formattedUrls;
                console.log(`üîó Postavljeno ${data.images.length} URL linkova slika (svaki u novom redu)`);
                console.log('üìù Formatiran sadr≈æaj:');
                console.log(formattedUrls);
            }
        }
        
        console.log('Form filled with imported data:', data);
        console.log('Engine extracted from title:', window.extractedEngine);
    }
    
    function handleImportedImages(base64Images) {
        try {
            const carImagesInput = document.getElementById('carImages');
            const carImagesInfo = document.getElementById('carImagesInfo');
            
            // Convert base64 images to File objects
            const files = [];
            
            base64Images.forEach((base64, index) => {
                try {
                    // Extract MIME type and data from base64 string
                    const [header, data] = base64.split(',');
                    const mimeMatch = header.match(/data:([^;]+)/);
                    const mimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';
                    
                    // Convert base64 to binary
                    const byteCharacters = atob(data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    
                    // Create File object
                    const file = new File([byteArray], `imported-image-${index + 1}.jpg`, {
                        type: mimeType
                    });
                    
                    files.push(file);
                } catch (error) {
                    console.warn('Failed to convert base64 image:', error);
                }
            });
            
            if (files.length > 0) {
                // Create a new FileList-like object
                const dataTransfer = new DataTransfer();
                files.forEach(file => dataTransfer.items.add(file));
                
                // Set the files to the input
                carImagesInput.files = dataTransfer.files;
                
                // Update the info text
                carImagesInfo.textContent = `${files.length} slika uvo≈æeno automatski`;
                carImagesInfo.style.color = '#27ae60';
                
                // Trigger the change event to update any listeners
                carImagesInput.dispatchEvent(new Event('change', { bubbles: true }));
                
                console.log(`Successfully imported ${files.length} images`);
            }
            
        } catch (error) {
            console.error('Error handling imported images:', error);
        }
    }
    // Fade animations keyframes (injected if not exists)
    const styleAnim = document.createElement('style');
    styleAnim.innerHTML = `@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}`;
    document.head.appendChild(styleAnim);

    window.onload = function() {
        var addCarBtnWrap = document.getElementById('addCarBtnWrap');
        var showAddCarBtn = document.getElementById('showAddCarBtn');
        var dodajOglasDropdownLi = document.getElementById('dodajOglasDropdownLi');
        var katalogDropdownLi = document.getElementById('katalogDropdownLi');
        var loginNavLi = document.getElementById('loginNavLi');
        var logoutNavLi = document.getElementById('logoutNavLi');
        var admin = isAdmin();
        
        // Debug logging
        console.log('üîê Admin check na load:', admin, 'localStorage:', localStorage.getItem('apm_admin'));
        console.log('üì± Mobile width:', window.innerWidth <= 768 ? 'DA' : 'NE');
        
        // Prikaz/skrivanje admin UI
        if (!admin) {
            if(addCarBtnWrap) {
                addCarBtnWrap.style.display = 'none';
                console.log('üö´ Admin dugmad sakrivena za guest');
            }
            if(dodajOglasDropdownLi) {
                dodajOglasDropdownLi.style.display = 'none';
                console.log('üö´ Dropdown "Dodaj oglas" sakriven za guest');
            }
            // Sakrij ceo dropdown jer nema sadr≈æaja za guest-e
            if(katalogDropdownLi) {
                // Ukloni dropdown funkcionalnost za guest-e - katalog link radi direktno
                const katalogLink = document.getElementById('katalogLink');
                const katalogDropdown = document.getElementById('katalogDropdown');
                if (katalogLink) {
                    katalogLink.onclick = null; // Ukloni dropdown toggle
                    console.log('üö´ Katalog dropdown onemoguƒáen za guest');
                }
                // Sakrij dropdown meni potpuno za guest-e
                if (katalogDropdown) {
                    katalogDropdown.style.display = 'none !important';
                    katalogDropdown.style.visibility = 'hidden';
                    console.log('üö´ Katalog dropdown menu sakriven za guest');
                }
            }
            if(loginNavLi) loginNavLi.style.display = '';
            if(logoutNavLi) logoutNavLi.style.display = 'none';
        } else {
            if(addCarBtnWrap) {
                addCarBtnWrap.style.display = '';
                console.log('‚úÖ Admin dugmad prikazana za admin');
            }
            if(dodajOglasDropdownLi) {
                dodajOglasDropdownLi.style.display = '';
                console.log('‚úÖ Dropdown "Dodaj oglas" prikazan za admin');
            }
            // Prika≈æi katalog dropdown za admin-e
            if(katalogDropdownLi) {
                const katalogDropdown = document.getElementById('katalogDropdown');
                if (katalogDropdown) {
                    katalogDropdown.style.display = '';
                    katalogDropdown.style.visibility = 'visible';
                    console.log('‚úÖ Katalog dropdown menu prikazan za admin');
                }
            }
            if(loginNavLi) loginNavLi.style.display = 'none';
            if(logoutNavLi) logoutNavLi.style.display = '';
        }
        if (showAddCarBtn) {
            showAddCarBtn.onclick = function() {
                if (!isAdmin()) {
                    window.location.href = 'login.html';
                    return;
                }
                openAdminModal();
                if(addCarBtnWrap) addCarBtnWrap.style.display = 'none';
            };
        }

        // Import button event listener
        var importCarBtn = document.getElementById('importCarBtn');
        if (importCarBtn) {
            importCarBtn.onclick = function() {
                if (!isAdmin()) {
                    window.location.href = 'login.html';
                    return;
                }
                openImportModal();
            };
        }

        // Import modal close logic
        var closeImportBtn = document.getElementById('closeImportModalBtn');
        var cancelImportBtn = document.getElementById('cancelImportBtn');
        if (closeImportBtn) closeImportBtn.onclick = closeImportModal;
        if (cancelImportBtn) cancelImportBtn.onclick = closeImportModal;
        var importOverlay = document.getElementById('importModalOverlay');
        if (importOverlay) importOverlay.onclick = function(e) {
            if (e.target === importOverlay) closeImportModal();
        };

        // Start import button
        var startImportBtn = document.getElementById('startImportBtn');
        if (startImportBtn) startImportBtn.onclick = startImport;
        // Modal close logic
        var closeBtn = document.getElementById('closeAdminPanelBtn');
        if (closeBtn) closeBtn.onclick = closeAdminModal;
        var overlay = document.getElementById('adminModalOverlay');
        if (overlay) overlay.onclick = function(e) {
            if (e.target === overlay) closeAdminModal();
        };
        renderCatalog();
    }

    // Form submit logic
    document.addEventListener('DOMContentLoaded', function() {
        // Formatiranje cene sa taƒçkama
        function formatPrice(value) {
            // Ukloni sve ≈°to nije cifra
            const numericValue = value.replace(/\D/g, '');
            
            // Dodaj taƒçke kao separatore hiljada
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Event listener za formatiranje cene u realnom vremenu
        const priceInput = document.getElementById('carPrice');
        if (priceInput) {
            priceInput.addEventListener('input', function(e) {
                const cursorPosition = e.target.selectionStart;
                const oldValue = e.target.value;
                const formattedValue = formatPrice(e.target.value);
                
                e.target.value = formattedValue;
                
                // Odr≈æi poziciju kursora
                const newCursorPosition = cursorPosition + (formattedValue.length - oldValue.length);
                e.target.setSelectionRange(newCursorPosition, newCursorPosition);
            });
        }

        const addCarForm = document.getElementById('addCarForm');
        if (addCarForm) {
            addCarForm.onsubmit = async function(e) {
                try {
                if (!isAdmin()) {
                    e.preventDefault();
                    window.location.href = 'login.html';
                    return false;
                }
                e.preventDefault();
                // Prikupljanje podataka iz forme
                const imagesInput = document.getElementById('carImages');
                const modelInput = document.getElementById('carModel');
                const kmInput = document.getElementById('carKm');
                const yearInput = document.getElementById('carYear');
                const kwInput = document.getElementById('carKw');
                const engineInput = document.getElementById('carEngine');
                const priceInput = document.getElementById('carPrice');
                const descInput = document.getElementById('carDesc');
                const fuelInput = document.getElementById('carFuel');

                // Validacija
                if (!modelInput.value.trim() || !kmInput.value || !yearInput.value.trim() || !kwInput.value || !priceInput.value || !fuelInput.value) {
                    alert('Popunite sva obavezna polja!');
                    return false;
                }

                // Rukovanje slikama - priority URL linkovi, zatim upload
                let images = [];
                const imageUrlsInput = document.getElementById('carImageUrls');
                
                // Prvo proverava URL linkove - POBOLJ≈†AN parsing
                if (imageUrlsInput.value.trim()) {
                    console.log('üîç RAW URL input:', imageUrlsInput.value);
                    
                    // NAPREDNI parsing - rukuje prelamanjem redova
                    let urlText = imageUrlsInput.value.trim();
                    
                    // 1. Zameni sve prelame sa razmakom
                    urlText = urlText.replace(/\s+/g, ' ');
                    
                    // 2. Pronaƒëi sve URL-ove koristeƒái regex
                    const urlPattern = /https?:\/\/[^\s]+/g;
                    const foundUrls = urlText.match(urlPattern) || [];
                    
                    // 3. Oƒçisti URL-ove od dodatnih karaktera
                    const validUrls = foundUrls
                        .map(url => {
                            // Ukloni trailing karaktere koji nisu deo URL-a
                            return url.replace(/[,;.\s]+$/, '');
                        })
                        .filter(url => url.length > 10); // Samo validne URL-ove
                    
                    console.log(`üîó PRONAƒêENO ${validUrls.length} URL-ova:`);
                    validUrls.forEach((url, i) => console.log(`  ${i+1}. ${url}`));
                    
                    images = validUrls;
                    console.log(`üîó Koristi se ${validUrls.length} URL linkova slika (NEOGRANIƒåENO)`);
                    
                } else if (imagesInput.files && imagesInput.files.length > 0) {
                    // Ako nema URL-ova, koristi upload slike
                    console.log(`üñºÔ∏è Pronaƒëeno ${imagesInput.files.length} upload slika`);
                    
                    // AI selekcija najboljih slika
                    const selectedFiles = await selectBestImages(Array.from(imagesInput.files));
                    console.log(`üéØ AI odabrao ${selectedFiles.length} slika za obradu`);
                    
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        
                        try {
                            // Kompresija slika sa AI optimizovanim parametrima
                            let quality = 0.6; // Dobar balans kvaliteta i veliƒçine
                            let maxWidth = 800;
                            let maxHeight = 600;
                            
                            // Dodatna kompresija za veƒáe fajlove
                            if (file.size > 2 * 1024 * 1024) {
                                quality = 0.4;
                                maxWidth = 700;
                                maxHeight = 525;
                            }
                            
                            const compressedBase64 = await compressImage(file, maxWidth, maxHeight, quality);
                            images.push(compressedBase64);
                            console.log(`‚úÖ Slika ${i+1} obraƒëena`);
                        } catch (error) {
                            console.error(`‚ùå Gre≈°ka pri obradi slike ${i+1}:`, error);
                        }
                    }
                    
                    if (imagesInput.files.length > selectedFiles.length) {
                        const skippedCount = imagesInput.files.length - selectedFiles.length;
                        console.log(`‚ÑπÔ∏è AI je preskoƒçio ${skippedCount} slika zbog optimizacije prostora`);
                    }
                }
                
                // Provera da li ima slika
                if (images.length === 0) {
                    alert('Molimo dodajte barem jednu sliku (upload ili URL link)!');
                    return false;
                }

                // Izraƒçun KS iz unetih kW (1 kW ‚âà 1.35962 KS)
                const kwVal = parseInt(kwInput.value, 10);
                const ks = isNaN(kwVal) ? '' : Math.round(kwVal * 1.35962);

                // Ukloni taƒçke iz cene za ƒçuvanje
                const priceValue = priceInput.value.replace(/\./g, '');

                // Kreiraj objekat vozila
                const car = {
                    images,
                    model: modelInput.value.trim(),
                    km: kmInput.value,
                    year: yearInput.value.trim(),
                    kw: kwInput.value,
                    ks: ks,
                    engine: engineInput.value.trim(),
                    fuel: fuelInput.value,
                    price: priceValue,
                    desc: descInput.value.trim()
                };

                // Dodaj u localStorage sa naprednom strategijom
                
                // Proveri trenutnu veliƒçinu localStorage-a
                const currentSize = getLocalStorageSize();
                console.log('localStorage veliƒçina:', (currentSize / 1024).toFixed(1), 'KB');
                
                const cars = JSON.parse(localStorage.getItem('cars') || '[]');
                cars.unshift(car); // najnoviji na vrhu
                
                try {
                    localStorage.setItem('cars', JSON.stringify(cars));
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        console.log('localStorage pun, poku≈°avam optimizaciju...');
                        
                        // Strategija 1: Optimizuj postojeƒáe slike
                        optimizeExistingImages();
                        try {
                            const optimizedCars = JSON.parse(localStorage.getItem('cars') || '[]');
                            optimizedCars.unshift(car);
                            localStorage.setItem('cars', JSON.stringify(optimizedCars));
                            console.log('Vozilo dodano nakon optimizacije postojeƒáih slika');
                        } catch (error2) {
                            // Strategija 2: Ukloni najstarija vozila (zadr≈æi 15)
                            cleanOldCars(15);
                            try {
                                const remainingCars = JSON.parse(localStorage.getItem('cars') || '[]');
                                remainingCars.unshift(car);
                                localStorage.setItem('cars', JSON.stringify(remainingCars));
                                console.log('Vozilo dodano - zadr≈æano 15 najnovijih');
                            } catch (error3) {
                                // Strategija 3: Zadr≈æi samo 10 vozila
                                cleanOldCars(10);
                                try {
                                    const recentCars = JSON.parse(localStorage.getItem('cars') || '[]');
                                    recentCars.unshift(car);
                                    localStorage.setItem('cars', JSON.stringify(recentCars));
                                    console.log('Vozilo dodano - zadr≈æano 10 najnovijih');
                                } catch (error4) {
                                    // Strategija 4: Ultra kompresija
                                    cleanOldCars(5);
                                    // UKLONJENO ograniƒçenje na broj slika
                                    const finalCars = JSON.parse(localStorage.getItem('cars') || '[]');
                                    finalCars.unshift(car);
                                    localStorage.setItem('cars', JSON.stringify(finalCars));
                                    console.log('Vozilo dodano sa ultra kompresijom - zadr≈æano 5 vozila (sve slike)');
                                }
                            }
                        }
                    } else {
                        throw error;
                    }
                }

                // Oƒçisti formu
                addCarForm.reset();
                // Oƒçisti i URL polje eksplicitno
                document.getElementById('carImageUrls').value = '';

                // Sakrij modal i prika≈æi dugme
                closeAdminModal();

                // Osve≈æi katalog
                renderCatalog();
                console.log('Vozilo je uspe≈°no objavljeno!');
                
                // AUTOMATSKI SISTEM ANALIZE I ƒåI≈†ƒÜENJA SLIKA
                console.log('üöÄ POKRETAM AUTOMATSKI SISTEM ANALIZE SLIKA...');
                
                // Saƒçekaj da se katalog uƒçita (3 sekunde)
                setTimeout(() => {
                    console.log('üîç POKRETAM analyzeOnly() - Analiziram sve slike...');
                    analyzeOnly().then(() => {
                        console.log('‚úÖ Analiza zavr≈°ena, pokretam konzervativno ƒçi≈°ƒáenje...');
                        
                        // Saƒçekaj 2 sekunde pa pokreni ƒçi≈°ƒáenje
                        setTimeout(() => {
                            console.log('‚öñÔ∏è POKRETAM conservativeCleanUp() - Bri≈°em samo lo≈°e slike...');
                            conservativeCleanUp().then(() => {
                                console.log('üéâ AUTOMATSKI SISTEM ZAVR≈†EN - Slike su optimizovane!');
                            }).catch(error => {
                                console.error('‚ùå Gre≈°ka u ƒçi≈°ƒáenju:', error);
                            });
                        }, 2000);
                        
                    }).catch(error => {
                        console.error('‚ùå Gre≈°ka u analizi:', error);
                    });
                }, 3000);
                
                // Prika≈æi poruku korisniku
                const totalImages = car.images.length;
                const originalCount = imagesInput.files ? imagesInput.files.length : 0;
                const usedUrls = imageUrlsInput.value.trim() !== '';
                
                if (totalImages > 0) {
                    if (usedUrls) {
                        alert(`‚úÖ Vozilo je uspe≈°no objavljeno sa ${totalImages} URL linkova slika!\n\nüí° URL linkovi tro≈°e daleko manje prostora od upload slika.`);
                    } else if (originalCount > totalImages) {
                        alert(`ü§ñ AI je izabrao ${totalImages} najboljih slika od ${originalCount} ukupno!\n\nVozilo je uspe≈°no objavljeno.`);
                    } else {
                        alert(`Vozilo je uspe≈°no objavljeno sa ${totalImages} ${totalImages === 1 ? 'slikom' : totalImages < 5 ? 'slike' : 'slika'}!`);
                    }
                } else {
                    alert('Vozilo je uspe≈°no objavljeno!');
                }
                } catch (error) {
                    console.error('Gre≈°ka pri objavljivanju vozila:', error);
                    alert('Do≈°lo je do gre≈°ke pri objavljivanju vozila. Molimo poku≈°ajte ponovo.');
                }
            };
        }
        
        // Optimizuj prostor dugme uklonjeno
        // const optimizeStorageBtn = document.getElementById('optimizeStorageBtn');
    });

    // ISPRAVKA - Sigurno uƒçitavanje slika sa direktnim URL-om kao prvi poku≈°aj
    function createSafeImage(imageUrl, altText, className = '', styles = '') {
        // Lista proxy servisa za fallback (direktno prvo!)
        const proxies = [
            '',                                         // DIREKTNO - kao prvi poku≈°aj
            'https://images.weserv.nl/?url=',           // Weserv - kao backup
            'https://api.allorigins.win/raw?url=',      // AllOrigins
            'https://cors-anywhere.herokuapp.com/',    // CORS Anywhere
            'https://thingproxy.freeboard.io/fetch/',  // ThingProxy
        ];
        
        let fallbackChain = '';
        
        // Kreiraj chain od proxy servisa
        for (let i = 0; i < proxies.length; i++) {
            const proxy = proxies[i];
            const finalUrl = proxy ? proxy + encodeURIComponent(imageUrl) : imageUrl;
            const nextProxy = i < proxies.length - 1 ? 
                'this.src=\'' + (proxies[i+1] ? proxies[i+1] + encodeURIComponent(imageUrl) : imageUrl) + '\'; console.log(\'üîÑ Poku≈°avam proxy ' + (i+2) + ' za: ' + altText + '\');' : 
                'this.style.opacity=\'0.3\'; console.log(\'‚ö†Ô∏è Sve opcije neuspe≈°ne za: ' + altText + '\');';
            
            if (i === 0) {
                // Prvi poku≈°aj
                fallbackChain = 'this.onerror=function(){' + nextProxy + '};';
            }
        }
        
        // KORISTI DIREKTAN URL kao prvi poku≈°aj
        const primaryUrl = imageUrl;
        
        return '<div class="image-container" style="position:relative;">' +
               '<img src="' + primaryUrl + '" ' +
               'class="' + className + '" ' +
               'alt="' + altText + '" ' +
               'style="' + styles + '" ' +
               'onerror="' + fallbackChain + '" ' +
               'onload="console.log(\'‚úÖ Slika uƒçitana: ' + altText + '\');">' +
               '</div>';
    }

    // NOVA funkcija za potpuno sakrivanje neuspe≈°nih slika
    function hideFailedImageCompletely(imgElement) {
        const container = imgElement.closest('.image-container') || imgElement.parentElement;
        const carCard = imgElement.closest('.car-card');
        
        if (container) {
            // Sakrij ceo kontejner slike
            container.style.display = 'none';
            container.style.visibility = 'hidden';
            container.style.height = '0';
            container.style.overflow = 'hidden';
            
            // Ako je ovo glavna slika automobila, dodaj placeholder ili promeni layout
            if (carCard) {
                const isMainImage = imgElement.classList.contains('car-image');
                if (isMainImage) {
                    // Dodaj diskretnu oznaku da nema sliku
                    const noImagePlaceholder = document.createElement('div');
                    noImagePlaceholder.className = 'no-image-placeholder';
                    noImagePlaceholder.style.cssText = 'height:50px;background:linear-gradient(135deg,#f8f9fa,#e9ecef);display:flex;align-items:center;justify-content:center;color:#6c757d;font-size:12px;border-radius:8px;margin:10px;opacity:0.7;';
                    noImagePlaceholder.innerHTML = 'ÔøΩ ' + (imgElement.alt || 'Vozilo');
                    
                    // Ubaci placeholder umesto glavne slike
                    container.parentNode.insertBefore(noImagePlaceholder, container);
                }
            }
        }
        
        // A≈æuriraj statistike
        updateRealImageStatistics();
    }

    // GLOBALNE varijable za praƒáenje slika
    window.imageLoadingStats = {
        total: 0,
        loaded: 0,
        failed: 0
    };

    // NOVA funkcija za stvarno praƒáenje uƒçitavanja slika
    function checkImageLoaded(imgElement, carModel) {
        // Proveri da li je slika stvarno uƒçitana
        if (imgElement.complete && imgElement.naturalWidth > 0 && imgElement.naturalHeight > 0) {
            window.imageLoadingStats.loaded++;
            console.log(`‚úÖ USPE≈†NO uƒçitana slika: ${carModel} (${window.imageLoadingStats.loaded}/${window.imageLoadingStats.total})`);
            console.log(`üìê Dimenzije: ${imgElement.naturalWidth}x${imgElement.naturalHeight}px`);
        } else {
            // Slika je tehniƒçki "uƒçitana" ali je prazna ili o≈°teƒáena
            console.log(`‚ö†Ô∏è SLIKA UƒåITANA ALI NEISPRAVNA: ${carModel}`);
            console.log(`üìê Dimenzije: ${imgElement.naturalWidth || 0}x${imgElement.naturalHeight || 0}px`);
            console.log(`üîó URL: ${imgElement.src}`);
            
            // Ne brojimo kao failed ovde jer mo≈æda jo≈° uvek poku≈°ava fallback
        }
        
        // A≈æuriraj statistike
        updateRealImageStatistics();
    }

    // POBOLJ≈†ANA funkcija za taƒçne statistike
    function updateRealImageStatistics() {
        const totalAttempts = window.imageLoadingStats.total;
        const successful = window.imageLoadingStats.loaded;
        const failed = window.imageLoadingStats.failed;
        const pending = totalAttempts - successful - failed;
        
        if (totalAttempts > 0) {
            console.log(`ÔøΩ STVARNE STATISTIKE SLIKA:`);
            console.log(`‚Ä¢ Ukupno poku≈°aja: ${totalAttempts}`);
            console.log(`‚Ä¢ Uspe≈°no uƒçitane: ${successful} (${((successful/totalAttempts)*100).toFixed(1)}%)`);
            console.log(`‚Ä¢ Neuspe≈°ne: ${failed} (${((failed/totalAttempts)*100).toFixed(1)}%)`);
            console.log(`‚Ä¢ U toku: ${pending}`);
        }
    }

    // NOVA funkcija za detaljnu analizu slika
    function analyzeImageStatus() {
        const allImages = document.querySelectorAll('img.car-image');
        const results = {
            loaded: 0,
            failed: 0,
            loading: 0,
            broken: 0
        };
        
        console.log(`üîç DETALJANA ANALIZA ${allImages.length} PREVIEW SLIKA:`);
        
        allImages.forEach((img, index) => {
            const model = img.alt || `Auto ${index + 1}`;
            
            if (!img.complete) {
                results.loading++;
                console.log(`‚è≥ ${model}: Jo≈° se uƒçitava...`);
            } else if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                results.loaded++;
                console.log(`‚úÖ ${model}: OK (${img.naturalWidth}x${img.naturalHeight}px)`);
            } else {
                results.broken++;
                console.log(`üíÄ ${model}: O≈°teƒáena/prazna slika - ${img.src.substring(0, 80)}...`);
            }
        });
        
        console.log(`üìà ANALIZA ZAVR≈†ENA:`);
        console.log(`‚Ä¢ Uspe≈°ne: ${results.loaded}/${allImages.length} (${((results.loaded/allImages.length)*100).toFixed(1)}%)`);
        console.log(`‚Ä¢ O≈°teƒáene: ${results.broken}/${allImages.length} (${((results.broken/allImages.length)*100).toFixed(1)}%)`);
        console.log(`‚Ä¢ Jo≈° se uƒçitavaju: ${results.loading}/${allImages.length}`);
        
        return results;
    }

    // CACHE za testiranje slika - spreƒçava ponavljanje testova
    window.imageTestCache = new Map();
    
    // Funkcija za ƒçi≈°ƒáenje cache-a (pozovi kad ≈æeli≈° fresh test)
    function clearImageTestCache() {
        window.imageTestCache.clear();
        console.log('üóëÔ∏è Cache testiranja slika je oƒçi≈°ƒáen - slike ƒáe se ponovo testirati');
    }
    
    // Funkcija za potpuno osve≈æavanje kataloga (re≈°ava problem izgubljenih slika)
    function refreshCatalogImages() {
        console.log('üîÑ OSVE≈ΩAVAM KATALOG - Vraƒáam originalne slike...');
        
        // Oƒçisti image cache
        clearImageTestCache();
        
        // Osvezi katalog prikaz
        renderCatalogOnLoad();
        
        console.log('‚úÖ Katalog je osve≈æen - sve slike treba da se vrate!');
    }
    
    // NOVA FUNKCIJA - ƒåisti slike samo za zadati automobil (ne sve!)
    async function cleanImagesForCar(carIndex) {
        console.log(`üéØ ƒåI≈†ƒÜENJE SLIKA SAMO ZA AUTOMOBIL ${carIndex + 1}...`);
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        if (!cars[carIndex]) {
            console.log('‚ùå Automobil ne postoji!');
            return;
        }
        
        const car = cars[carIndex];
        if (!car.images || car.images.length === 0) {
            console.log('‚ÑπÔ∏è Automobil nema slike za ƒçi≈°ƒáenje');
            return;
        }
        
        const originalCount = car.images.length;
        console.log(`üîç Testiram ${car.model} - ${car.images.length} slika...`);
        
        // Testiraj sve slike ovog automobila
        const imageTests = car.images.map(async (imageUrl, imageIndex) => {
            const isWorking = await testImageUrl(imageUrl);
            return { imageUrl, isWorking, index: imageIndex };
        });
        
        const results = await Promise.all(imageTests);
        
        // Filtriranje radnih slika
        const cleanedImages = results
            .filter(result => result.isWorking)
            .map(result => result.imageUrl);
        
        // A≈æuriraj samo ovaj automobil
        if (cleanedImages.length !== originalCount) {
            if (cleanedImages.length > 0) {
                car.images = cleanedImages;
                console.log(`‚úÖ ${car.model}: ${originalCount} ‚Üí ${cleanedImages.length} slika`);
            } else {
                car.images = ['https://via.placeholder.com/400x300/e8e8e8/999999?text=' + encodeURIComponent(car.model || 'Auto')];
                console.log(`üì∑ ${car.model}: Sve slike uklonjene - placeholder dodat`);
            }
            
            // Saƒçuvaj promene
            localStorage.setItem('cars', JSON.stringify(cars));
            console.log(`üíæ Saƒçuvano - oƒçi≈°ƒáen samo ${car.model}`);
            
            // Osvezi prikaz
            setTimeout(() => renderCatalogOnLoad(), 500);
        } else {
            console.log(`‚ú® ${car.model}: Sve slike rade!`);
        }
    }
    
    // NOVA FUNKCIJA - Obnovi izgubljene slike za stare automobile
    async function restoreOldCarsImages() {
        console.log('üîß OBNAVLJAM SLIKE STARIH AUTOMOBILA...');
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let restored = 0;
        
        for (let i = 0; i < cars.length; i++) {
            const car = cars[i];
            
            // Ako automobil ima samo placeholder sliku, mo≈æda je imao prave slike
            if (car.images && car.images.length === 1 && 
                car.images[0].includes('placeholder.com')) {
                
                console.log(`üîç ${car.model}: Ima placeholder - mo≈æda je imao prave slike`);
                
                // Mo≈æda mo≈æemo da recuperiramo iz cache-a ili localStorage backup-a
                // Za sada samo oznaƒçavam da treba ruƒçno dodavanje slika
                console.log(`‚ö†Ô∏è ${car.model}: Potrebno ruƒçno dodavanje slika`);
                restored++;
            }
        }
        
        if (restored > 0) {
            console.log(`üìä PRONAƒêENO ${restored} automobila sa placeholder slikama`);
            console.log(`üí° PREPORUƒåUJEM: Ruƒçno dodajte slike kroz "Dodaj oglas" ili importujte ponovo`);
        } else {
            console.log('‚úÖ Svi automobili imaju prave slike!');
        }
    }
    
    // AUTOMATSKA TEST FUNKCIJA - Testira sve za korisnika
    async function runCompleteSystemTest() {
        console.log('üöÄ POKRETAM KOMPLETNO TESTIRANJE SISTEMA...');
        console.log('=' .repeat(60));
        
        // 1. Osnovne informacije
        console.log('üìä OSNOVNE INFORMACIJE:');
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        console.log(`‚Ä¢ Ukupno automobila: ${cars.length}`);
        console.log(`‚Ä¢ Admin status: ${isAdmin() ? 'ULOGOVAN' : 'NIJE ULOGOVAN'}`);
        console.log(`‚Ä¢ Screen width: ${window.innerWidth}px`);
        console.log('');
        
        // 2. Pregled automobila
        console.log('üöó PREGLED AUTOMOBILA:');
        cars.forEach((car, index) => {
            const imageCount = car.images ? car.images.length : 0;
            const hasPlaceholder = car.images && car.images[0] && car.images[0].includes('placeholder.com');
            console.log(`${index + 1}. ${car.model} - ${imageCount} slika ${hasPlaceholder ? '(PLACEHOLDER!)' : ''}`);
        });
        console.log('');
        
        // 3. Test cache sistema
        console.log('üíæ CACHE SISTEM:');
        console.log(`‚Ä¢ Cache veliƒçina: ${window.imageTestCache ? window.imageTestCache.size : 0} URL-ova`);
        console.log('');
        
        // 4. Brza analiza slika
        console.log('‚ö° BRZA ANALIZA SLIKA:');
        console.log('(Testiram samo prve 3 automobila za brzinu...)');
        
        const testLimit = Math.min(3, cars.length);
        for (let i = 0; i < testLimit; i++) {
            const car = cars[i];
            if (!car.images || car.images.length === 0) {
                console.log(`${i + 1}. ${car.model}: NEMA SLIKA`);
                continue;
            }
            
            console.log(`${i + 1}. Testiram ${car.model}...`);
            
            // Test samo prve slike za brzinu
            const firstImage = car.images[0];
            if (firstImage.includes('placeholder.com')) {
                console.log(`   ‚ö†Ô∏è PLACEHOLDER slika - automobil je izgubio originalne slike`);
            } else {
                // Brz test (500ms timeout)
                const isWorking = await new Promise((resolve) => {
                    const img = new Image();
                    const timeout = setTimeout(() => resolve(false), 500);
                    img.onload = () => { clearTimeout(timeout); resolve(true); };
                    img.onerror = () => { clearTimeout(timeout); resolve(false); };
                    img.src = firstImage;
                });
                
                console.log(`   ${isWorking ? '‚úÖ' : '‚ùå'} Prva slika: ${isWorking ? 'RADI' : 'NE RADI'}`);
            }
        }
        console.log('');
        
        // 5. Preporuke
        console.log('üí° PREPORUKE:');
        const carsWithPlaceholders = cars.filter(car => 
            car.images && car.images[0] && car.images[0].includes('placeholder.com')
        ).length;
        
        if (carsWithPlaceholders > 0) {
            console.log(`‚ö†Ô∏è PROBLEM: ${carsWithPlaceholders} automobil(a) ima placeholder slike!`);
            console.log('üîß RE≈†ENJE: Pokrenite restoreOldCarsImages()');
        } else {
            console.log('‚úÖ Svi automobili imaju prave slike');
        }
        
        if (cars.length > 10) {
            console.log('üí° TIP: Za veliki broj automobila, koristite cleanImagesForCar(index) umesto masovnog ƒçi≈°ƒáenja');
        }
        
        console.log('');
        console.log('üéØ DOSTUPNE AKCIJE:');
        console.log('‚Ä¢ restoreOldCarsImages() - obnovi izgubljene slike');
        console.log('‚Ä¢ cleanImagesForCar(0) - oƒçisti samo prvi automobil');
        console.log('‚Ä¢ refreshCatalogImages() - osvezi katalog');
        console.log('‚Ä¢ analyzeOnly() - detaljna analiza svih slika');
        
        console.log('');
        console.log('‚úÖ TESTIRANJE ZAVR≈†ENO!');
        console.log('=' .repeat(60));
    }
    
    // NOVA FUNKCIJA - Bri≈°e samo slike sa HTTP error gre≈°kama
    async function cleanHttpErrorImages() {
        console.log('üö® ƒåI≈†ƒÜENJE SAMO HTTP ERROR SLIKA...');
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let totalCleaned = 0;
        let carsModified = 0;
        
        for (let carIndex = 0; carIndex < cars.length; carIndex++) {
            const car = cars[carIndex];
            if (!car.images || car.images.length === 0) continue;
            
            const originalCount = car.images.length;
            const cleanedImages = [];
            
            console.log(`üîç Testiram ${car.model} - ${car.images.length} slika za HTTP errore...`);
            
            // Testiraj sve slike ovog automobila paralelno
            const imageTests = car.images.map(async (imageUrl, imageIndex) => {
                // Samo brz test - 1 sekunda timeout
                const isWorking = await new Promise((resolve) => {
                    const img = new Image();
                    const timeout = setTimeout(() => {
                        resolve(false); // Prekini ako je sporo
                    }, 1000);
                    
                    img.onload = function() {
                        clearTimeout(timeout);
                        resolve(this.naturalWidth > 0 && this.naturalHeight > 0);
                    };
                    img.onerror = function() {
                        clearTimeout(timeout);
                        resolve(false); // HTTP error ili DNS problem
                    };
                    img.src = imageUrl;
                });
                
                return { imageUrl, isWorking, index: imageIndex };
            });
            
            const results = await Promise.all(imageTests);
            
            // Zadr≈æi samo radne slike
            results.forEach(result => {
                if (result.isWorking) {
                    cleanedImages.push(result.imageUrl);
                    console.log(`   ‚úÖ Slika ${result.index + 1}: RADI`);
                } else {
                    console.log(`   ‚ùå Slika ${result.index + 1}: HTTP ERROR - uklanjam`);
                    totalCleaned++;
                }
            });
            
            // A≈æuriraj automobil
            if (cleanedImages.length !== originalCount) {
                if (cleanedImages.length > 0) {
                    car.images = cleanedImages;
                    carsModified++;
                    console.log(`   üîß ${car.model}: ${originalCount} ‚Üí ${cleanedImages.length} slika`);
                } else {
                    car.images = ['https://via.placeholder.com/400x300/e8e8e8/999999?text=' + encodeURIComponent(car.model || 'Auto')];
                    carsModified++;
                    console.log(`   üì∑ ${car.model}: Sve slike uklonjene - placeholder dodat`);
                }
            }
        }
        
        // Saƒçuvaj promene
        if (carsModified > 0) {
            localStorage.setItem('cars', JSON.stringify(cars));
            console.log(`‚úÖ ZAVR≈†ENO: Uklonjeno ${totalCleaned} HTTP error slika, a≈æurirano ${carsModified} automobila`);
            
            // Osvezi prikaz
            setTimeout(() => {
                renderCatalogOnLoad();
            }, 500);
        } else {
            console.log('‚ú® Nema HTTP error slika za uklanjanje!');
        }
    }
    
    // ULTRA-BRZA FUNKCIJA sa cache-om - Br≈æe testiranje slika (2s umesto 8s)
    async function testImageUrl(url) {
        // Provjeri cache
        if (window.imageTestCache.has(url)) {
            return window.imageTestCache.get(url);
        }
        
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const result = this.naturalWidth > 0 && this.naturalHeight > 0;
                window.imageTestCache.set(url, result); // Saƒçuvaj u cache
                resolve(result);
            };
            img.onerror = function() {
                window.imageTestCache.set(url, false); // Saƒçuvaj u cache
                resolve(false);
            };
            
            // SKRAƒÜEN timeout - 2 sekunde umesto 8
            setTimeout(() => {
                window.imageTestCache.set(url, false); // Saƒçuvaj u cache
                resolve(false);
            }, 2000);
            
            img.src = url;
        });
    }

    // NOVA FUNKCIJA - Pametno ƒçi≈°ƒáenje koje stvarno testira svaku sliku
    // ULTRA-BRZA VERZIJA - Paralelno testiranje slika
    async function smartCleanUpBrokenImages() {
        console.log(`üöÄ UBRZANO PAMETNO ƒåI≈†ƒÜENJE - Testiram slike paralelno...`);
        console.log(`‚ö° Optimizacije: 2s timeout umesto 8s, cache testova, paralelno procesiranje`);
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let totalCleaned = 0;
        let carsModified = 0;
        let processedCars = 0;
        
        // Grupa automobila u batch-ove od 5 za paralelno procesiranje
        const BATCH_SIZE = 5;
        
        for (let i = 0; i < cars.length; i += BATCH_SIZE) {
            const batch = cars.slice(i, i + BATCH_SIZE);
            
            // Procesiraj batch paralelno
            await Promise.all(batch.map(async (car, localIndex) => {
                const carIndex = i + localIndex;
                if (!car.images || car.images.length === 0) {
                    processedCars++;
                    return;
                }
                
                const originalCount = car.images.length;
                console.log(`üîç ${processedCars + 1}/${cars.length} - ${car.model} (${car.images.length} slika)`);
                
                // Testiraj sve slike ovog automobila paralelno
                const imageTests = car.images.map(async (imageUrl, imageIndex) => {
                    // Prvo testiraj direktan URL brzo
                    let isWorking = await testImageUrl(imageUrl);
                    
                    // Ako ne radi, testiraj samo jedan proxy (ne sve)
                    if (!isWorking) {
                        const weservUrl = 'https://images.weserv.nl/?url=' + encodeURIComponent(imageUrl);
                        isWorking = await testImageUrl(weservUrl);
                    }
                    
                    return { imageUrl, isWorking, index: imageIndex };
                });
                
                // ƒåekaj da se svi testovi zavr≈°e
                const results = await Promise.all(imageTests);
                
                // Filtriranje radnih slika
                const cleanedImages = results
                    .filter(result => result.isWorking)
                    .map(result => result.imageUrl);
                
                const brokenCount = originalCount - cleanedImages.length;
                if (brokenCount > 0) {
                    totalCleaned += brokenCount;
                }
                
                // SIGURNOSNA PROVERA - Ne bri≈°i sve slike iz oglasa
                if (cleanedImages.length !== originalCount) {
                    if (cleanedImages.length > 0) {
                        // Ima funkcionalne slike - a≈æuriraj
                        car.images = cleanedImages;
                        carsModified++;
                        console.log(`   ‚úÖ ${originalCount} ‚Üí ${cleanedImages.length} slika (uklonjeno ${brokenCount})`);
                    } else {
                        // SVE slike su problematiƒçne - ostavi placeholder
                        console.log(`   ‚ö†Ô∏è Sve slike problematiƒçne - dodeljujem placeholder`);
                        car.images = ['https://via.placeholder.com/400x300/e8e8e8/999999?text=' + encodeURIComponent(car.model || 'Auto')];
                        carsModified++;
                    }
                } else {
                    console.log(`   ‚ú® Sve slike funkcionalne!`);
                }
                
                processedCars++;
            }));
            
            // Progress update
            console.log(`üìä Progres: ${Math.min(i + BATCH_SIZE, cars.length)}/${cars.length} automobila`);
            
            // Kratka pauza izmeƒëu batch-ova da ne preopteretimo server
            if (i + BATCH_SIZE < cars.length) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // Saƒçuvaj promene
        if (carsModified > 0) {
            localStorage.setItem('cars', JSON.stringify(cars));
            
            console.log(`üéØ PAMETNO ƒåI≈†ƒÜENJE ZAVR≈†ENO:`);
            console.log(`‚Ä¢ Uklonjeno problematiƒçnih slika: ${totalCleaned}`);
            console.log(`‚Ä¢ A≈æurirano automobila: ${carsModified}`);
            console.log(`‚Ä¢ Saƒçuvano u localStorage ‚úÖ`);
            
            // Osvezi prikaz kataloga
            setTimeout(() => {
                console.log(`üîÑ Osve≈æavam katalog sa oƒçi≈°ƒáenim slikama...`);
                renderCatalogOnLoad();
            }, 1000);
        } else {
            console.log(`‚ú® Sve slike rade - nema potrebe za ƒçi≈°ƒáenjem!`);
        }
    }

    // STARA FUNKCIJA - Automatsko brisanje problematiƒçnih slika iz oglasa
    function cleanUpBrokenImages() {
        console.log(`üßπ POKRETANJE ƒåI≈†ƒÜENJA PROBLEMATIƒåNIH SLIKA...`);
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let totalCleaned = 0;
        let carsModified = 0;
        
        cars.forEach((car, carIndex) => {
            if (!car.images || car.images.length === 0) return;
            
            const originalCount = car.images.length;
            const cleanedImages = [];
            
            car.images.forEach((imageUrl, imageIndex) => {
                // Pronaƒëi odgovarajuƒáu sliku u DOM-u
                const modalSliderImages = document.querySelectorAll('.modal-slider-main, [id^="thumb-"]');
                let imageWorking = false;
                
                // Proverava sve slike u DOM-u sa istim URL-om
                modalSliderImages.forEach(img => {
                    if (img.src && (
                        img.src.includes(encodeURIComponent(imageUrl)) || 
                        img.src === imageUrl ||
                        img.dataset.originalUrl === imageUrl
                    )) {
                        // Proverava da li je slika stvarno uƒçitana
                        if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
                            imageWorking = true;
                        }
                    }
                });
                
                // Dodatna proverava preko test slike
                if (!imageWorking) {
                    const testImg = new Image();
                    testImg.onload = function() {
                        if (this.naturalWidth > 0 && this.naturalHeight > 0) {
                            imageWorking = true;
                        }
                    };
                    testImg.src = imageUrl;
                }
                
                if (imageWorking) {
                    cleanedImages.push(imageUrl);
                } else {
                    console.log(`üóëÔ∏è Bri≈°em problematiƒçnu sliku ${imageIndex + 1} iz ${car.model}: ${imageUrl.substring(0, 50)}...`);
                    totalCleaned++;
                }
            });
            
            // SIGURNOSNA PROVERA - Ne bri≈°i sve slike iz oglasa
            if (cleanedImages.length !== originalCount) {
                if (cleanedImages.length > 0) {
                    // Ima funkcionalne slike - a≈æuriraj
                    car.images = cleanedImages;
                    carsModified++;
                    console.log(`‚úÖ ${car.model}: ${originalCount} ‚Üí ${cleanedImages.length} slika (uklonjeno ${originalCount - cleanedImages.length})`);
                } else {
                    // SVE slike su problematiƒçne - ostavi barem jednu kao placeholder
                    console.log(`‚ö†Ô∏è ${car.model}: Sve slike problematiƒçne - ostavljam poslednju kao backup`);
                    car.images = [car.images[car.images.length - 1]]; // ƒåuva poslednju sliku
                    carsModified++;
                }
            }
        });
        
        // Saƒçuvaj promene
        if (carsModified > 0) {
            localStorage.setItem('cars', JSON.stringify(cars));
            
            console.log(`üéØ ƒåI≈†ƒÜENJE ZAVR≈†ENO:`);
            console.log(`‚Ä¢ Uklonjeno problematiƒçnih slika: ${totalCleaned}`);
            console.log(`‚Ä¢ A≈æurirano automobila: ${carsModified}`);
            console.log(`‚Ä¢ Saƒçuvano u localStorage ‚úÖ`);
            
            // Osvezi prikaz kataloga
            setTimeout(() => {
                console.log(`üîÑ Osve≈æavam katalog sa oƒçi≈°ƒáenim slikama...`);
                renderCatalogOnLoad();
            }, 1000);
        } else {
            console.log(`‚ú® Sve slike rade - nema potrebe za ƒçi≈°ƒáenjem!`);
        }
    }

    // POBOLJ≈†ANA FUNKCIJA - Detaljna analiza slika sa pamƒáenjem problematiƒçnih URL-ova
    function analyzeImageStatusAdvanced() {
        const allImages = document.querySelectorAll('img');
        const results = {
            loaded: 0,
            broken: 0,
            loading: 0,
            brokenUrls: []  // Lista problematiƒçnih URL-ova
        };
        
        console.log(`üîç DETALJANA ANALIZA ${allImages.length} SLIKA:`);
        
        allImages.forEach((img, i) => {
            const model = img.alt || `Slika ${i + 1}`;
            
            if (!img.complete) {
                results.loading++;
                console.log(`‚è≥ ${model}: Jo≈° se uƒçitava...`);
            } else if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                results.loaded++;
                console.log(`‚úÖ ${model}: OK (${img.naturalWidth}x${img.naturalHeight}px)`);
            } else {
                results.broken++;
                const originalUrl = extractOriginalUrl(img.src);
                if (originalUrl && !results.brokenUrls.includes(originalUrl)) {
                    results.brokenUrls.push(originalUrl);
                }
                console.log(`üíÄ ${model}: O≈°teƒáena/prazna slika - ${img.src.substring(0, 80)}...`);
            }
        });
        
        console.log(`üìà ANALIZA ZAVR≈†ENA:`);
        console.log(`‚Ä¢ Uspe≈°ne: ${results.loaded}/${allImages.length} (${((results.loaded/allImages.length)*100).toFixed(1)}%)`);
        console.log(`‚Ä¢ O≈°teƒáene: ${results.broken}/${allImages.length} (${((results.broken/allImages.length)*100).toFixed(1)}%)`);
        console.log(`‚Ä¢ Jo≈° se uƒçitavaju: ${results.loading}/${allImages.length}`);
        console.log(`‚Ä¢ Problematiƒçni URL-ovi:`, results.brokenUrls);
        
        return results;
    }

    // POMOƒÜNA FUNKCIJA - Izvlaƒçi originalni URL iz proxy URL-a
    function extractOriginalUrl(proxyUrl) {
        try {
            // Weserv.nl proxy
            if (proxyUrl.includes('images.weserv.nl')) {
                const match = proxyUrl.match(/url=([^&]+)/);
                return match ? decodeURIComponent(match[1]) : null;
            }
            
            // AllOrigins proxy
            if (proxyUrl.includes('allorigins.win')) {
                const match = proxyUrl.match(/url=([^&]+)/);
                return match ? decodeURIComponent(match[1]) : null;
            }
            
            // CORS Anywhere proxy
            if (proxyUrl.includes('cors-anywhere.herokuapp.com')) {
                return proxyUrl.replace('https://cors-anywhere.herokuapp.com/', '');
            }
            
            // Direktan URL
            return proxyUrl;
        } catch (e) {
            return proxyUrl;
        }
    }

    // UKLONJENA stara funkcija updateImageStatistics

    // POBOLJ≈†ANA funkcija za modal slider sa automatskim sakrivanjem neuspe≈°nih slika
    function createSafeModalSlider(car) {
        if (!car.images || car.images.length === 0) {
            return '<div style="text-align:center;padding:40px;color:#888;background:#f5f5f5;border-radius:12px;">üì∑ Nema slika</div>';
        }
        
        const mainImage = car.images[0];
        
        let slider = '<div class="car-slider" style="position:relative;width:100%;max-width:820px;height:520px;overflow:hidden;margin:0 auto 28px auto;background:#f5f5f5;border-radius:14px;">';
        
        // Main image sa naprednim fallback sistemom
        slider += '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">';
        slider += '<div onclick="openFullscreenFromModal(0)" style="cursor:pointer;position:relative;display:inline-block;">';
        slider += '<div style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:4px 8px;border-radius:12px;font-size:12px;z-index:2;">üîç Klikni za full screen</div>';
        slider += createSafeImage(
            mainImage, 
            'Glavna slika vozila', 
            'modal-slider-main', 
            'max-width:100%;max-height:100%;object-fit:contain;border-radius:14px;'
        );
        slider += '</div>';
        slider += '</div>';
        
        // Navigation buttons and thumbnails
        if (car.images.length > 1) {
            slider += '<button class="modal-slider-prev" onclick="navigateSlider(-1)" style="position:absolute;top:50%;left:18px;transform:translateY(-50%);background:rgba(0,0,0,0.6);color:white;border:none;border-radius:50%;width:48px;height:48px;font-size:24px;cursor:pointer;z-index:2;">‚Äπ</button>';
            slider += '<button class="modal-slider-next" onclick="navigateSlider(1)" style="position:absolute;top:50%;right:18px;transform:translateY(-50%);background:rgba(0,0,0,0.6);color:white;border:none;border-radius:50%;width:48px;height:48px;font-size:24px;cursor:pointer;z-index:2;">‚Ä∫</button>';
            
            slider += '<div class="modal-slider-thumbs" id="modalThumbnails" style="display:flex;gap:12px;position:absolute;bottom:15px;left:50%;transform:translateX(-50%);z-index:2;max-width:90%;overflow-x:auto;padding:5px;">';
            
            for (let i = 0; i < car.images.length; i++) {
                const img = car.images[i];
                const border = i === 0 ? '#e74c3c' : '#fff';
                const opacity = i === 0 ? '1' : '0.7';
                
                slider += '<div class="thumbnail-container" data-index="' + i + '" style="position:relative;flex-shrink:0;">';
                slider += createSafeImage(
                    img,
                    'Thumbnail ' + (i+1),
                    'thumb-' + i,
                    'width:100px;height:70px;object-fit:cover;border-radius:8px;border:2px solid ' + border + ';cursor:pointer;opacity:' + opacity + ';transition:all 0.2s;'
                );
                slider += '<div onclick="changeMainImage(' + i + ', \'' + img.replace(/'/g, "\\'") + '\')" style="position:absolute;top:0;left:0;width:100%;height:100%;cursor:pointer;"></div>';
                slider += '</div>';
            }
            
            slider += '</div>';
        }
        
        slider += '</div>';
        
        return slider;
    }

    // NOVA funkcija za dinamiƒçko a≈æuriranje thumbnails u modal-u
    function updateModalThumbnails() {
        const thumbnailContainer = document.getElementById('modalThumbnails');
        if (!thumbnailContainer) return;
        
        // Sakrij thumbnail kontejnere ƒçije slike nisu uƒçitane
        const thumbnails = thumbnailContainer.querySelectorAll('.thumbnail-container');
        let visibleThumbnails = [];
        
        thumbnails.forEach((container, index) => {
            const hiddenImage = container.querySelector('.image-container[style*="display: none"]');
            if (hiddenImage) {
                container.style.display = 'none';
                console.log(`üö´ Sakrivam thumbnail ${index + 1} jer slika nije uƒçitana`);
            } else {
                visibleThumbnails.push(container);
            }
        });
        
        // Reorganizuj indekse za preostale thumbnails
        visibleThumbnails.forEach((container, newIndex) => {
            container.dataset.visibleIndex = newIndex;
        });
        
        console.log(`üì∏ Modal: ${visibleThumbnails.length} od ${thumbnails.length} thumbnails je vidljivo`);
        
        // Ako nema vidljivih thumbnails, sakrij navigaciju
        if (visibleThumbnails.length <= 1) {
            const prevBtn = document.querySelector('.modal-slider-prev');
            const nextBtn = document.querySelector('.modal-slider-next');
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
            if (thumbnailContainer.parentElement) {
                thumbnailContainer.style.display = 'none';
            }
        }
    }

    // Globalna varijabla za trenutni indeks slike
    let currentSlideIndex = 0;
    let currentCarImages = [];

    // Funkcija za navigaciju kroz slike
    function navigateSlider(direction) {
        if (currentCarImages.length === 0) return;
        
        currentSlideIndex += direction;
        if (currentSlideIndex < 0) currentSlideIndex = currentCarImages.length - 1;
        if (currentSlideIndex >= currentCarImages.length) currentSlideIndex = 0;
        
        changeMainImage(currentSlideIndex, currentCarImages[currentSlideIndex]);
    }

    // Funkcija za menjanje glavne slike u modal-u
    function changeMainImage(index, newSrc) {
        const mainImg = document.querySelector('.modal-slider-main');
        const thumbs = document.querySelectorAll('.modal-slider-thumbs img');
        
        if (mainImg) {
            const weservUrl = 'https://images.weserv.nl/?url=' + encodeURIComponent(newSrc);
            mainImg.src = weservUrl;
            mainImg.onerror = function() { this.onerror = null; this.src = newSrc; };
            
            // A≈æuriraj onclick za fullscreen sa trenutnim indeksom
            const mainImgParent = mainImg.parentElement;
            if (mainImgParent) {
                mainImgParent.onclick = function() {
                    openFullscreenFromModal(index);
                };
            }
        }
        
        thumbs.forEach(function(thumb, i) {
            thumb.style.border = i === index ? '2px solid #e74c3c' : '2px solid #fff';
            thumb.style.opacity = i === index ? '1' : '0.7';
        });
    }

    let lastSearchValue = '';
    function renderCatalog(filteredCars) {
        const grid = document.getElementById('catalogGrid');
        grid.innerHTML = '';
        const cars = filteredCars || JSON.parse(localStorage.getItem('cars') || '[]');
        const admin = isAdmin();
        
        console.log(`üîê Admin status: ${admin ? 'ULOGOVAN' : 'NIJE ULOGOVAN'}`);
        console.log(`üì± User agent: ${navigator.userAgent.includes('Mobile') ? 'MOBILNI' : 'DESKTOP'}`);
        console.log(`üìè Screen width: ${window.innerWidth}px`);
        
        // BRZA PROVERA I POPRAVKA automobila bez slika
        let carsFixed = 0;
        cars.forEach((car, index) => {
            if (!car.images || car.images.length === 0) {
                car.images = ['https://via.placeholder.com/400x300/e8e8e8/999999?text=' + encodeURIComponent(car.model || 'Auto')];
                carsFixed++;
                console.log(`üîß Auto ${index + 1}: Dodao placeholder sliku`);
            }
        });
        
        if (carsFixed > 0) {
            localStorage.setItem('cars', JSON.stringify(cars));
            console.log(`‚úÖ Popravljen ${carsFixed} automobil(a) bez slika`);
        }
        
        // RESETUJ statistike uƒçitavanja slika
        window.imageLoadingStats = {
            total: cars.length, // Broj preview slika koje treba uƒçitati
            loaded: 0,
            failed: 0
        };
        
        // NOVA STATISTIKA - Prebrojava sve slike iz svih automobila
        let totalImages = 0;
        let carsWithImages = 0;
        cars.forEach(car => {
            if (car.images && car.images.length > 0) {
                totalImages += car.images.length;
                carsWithImages++;
            }
        });

        console.log(`üìä POKRETANJE UƒåITAVANJA:`);
        console.log(`‚Ä¢ Ukupno automobila: ${cars.length}`);
        console.log(`‚Ä¢ Preview slika za uƒçitavanje: ${cars.length}`);
        console.log(`‚Ä¢ Ukupno slika u modal-ima: ${totalImages}`);
        console.log(`‚Ä¢ Proseƒçno slika po autu: ${(totalImages/carsWithImages).toFixed(1)}`);
        
        if (cars.length === 0) {
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#e74c3c;">Nema rezultata za zadati model.</p>';
            return;
        }
        
        cars.forEach((car, idx) => {
            const card = document.createElement('div');
            card.className = 'car-card';
            card.onclick = () => openCarModal(idx);
            
            // DEBUG: Log za admin funkcionalnost
            if (idx === 0) {
                console.log(`üîê DEBUG - Prvi automobil - Admin: ${admin}, LocalStorage: ${localStorage.getItem('apm_admin')}`);
                console.log(`üì± Window width: ${window.innerWidth}px, Mobile: ${window.innerWidth <= 768}`);
                console.log(`üöó Generi≈°e se admin dugmad: ${admin ? 'DA - biƒáe generisan <div class="car-buttons"> sa delete-btn' : 'NE - samo load-more-btn'}`);
            }
            
            // Slika sa NAPREDNIM fallback sistemom za preview
            let imageHtml = '';
            if (car.images && car.images.length > 0) {
                console.log(`üñºÔ∏è Auto ${idx + 1} (${car.model}): ${car.images.length} slika(e)`);
                
                const imageUrl = car.images[0];
                const carModel = car.model;
                
                // ISPRAVLJEN fallback sistem - direktno prvo, zatim proxy
                const proxies = [
                    '',  // DIREKTNO - kao prvi poku≈°aj
                    'https://images.weserv.nl/?url=',
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/',
                ];
                
                const directUrl = imageUrl;  // PRVI poku≈°aj - direktno
                const weservUrl = proxies[1] + encodeURIComponent(imageUrl);
                const alloriginsUrl = proxies[2] + encodeURIComponent(imageUrl);
                const corsUrl = proxies[3] + imageUrl;
                
                // Kompletan fallback chain sa detaljnim logging-om
                const fallbackScript = `
                    var attempt = 0;
                    var carName = '${carModel}';
                    this.onerror = function() {
                        attempt++;
                        console.log('‚ùå Poku≈°aj ' + attempt + ' neuspe≈°an za: ' + carName);
                        
                        if (attempt === 1) {
                            this.src = '${weservUrl}';
                            console.log('üîÑ Poku≈°avam Weserv proxy za: ' + carName);
                        } else if (attempt === 2) {
                            this.src = '${alloriginsUrl}';
                            console.log('üîÑ Poku≈°avam AllOrigins proxy za: ' + carName);
                        } else if (attempt === 3) {
                            this.src = '${corsUrl}';
                            console.log('üîÑ Poku≈°avam CORS Anywhere za: ' + carName);
                        } else {
                            console.log('üíÄ SVI POKU≈†AJI NEUSPE≈†NI za: ' + carName);
                            window.imageLoadingStats.failed++;
                            updateRealImageStatistics();
                            this.onerror = null;
                        }
                    };
                `;
                
                imageHtml = '<img src="' + directUrl + '" class="car-image" alt="' + carModel + '" ' +
                           'style="width:100%;height:280px;object-fit:cover;" ' +
                           'onload="checkImageLoaded(this, \'' + carModel + '\');" ' +
                           'onerror="' + fallbackScript.replace(/\n/g, ' ').replace(/\s+/g, ' ') + '">';
            } else {
                imageHtml = '<div class="car-image" style="width:100%;height:280px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;color:#999;">Nema slike</div>';
            }
            
            // Kompaktne informacije
            const specs = `
                <div class="car-info">
                    <div class="car-title">${car.model}</div>
                    <div class="car-price">‚Ç¨${formatPrice(car.price)}</div>
                    <div class="car-specs-compact">
                        <div class="spec-item">
                            <span class="spec-label">Kilometra≈æa:</span>
                            <span>${formatKm(car.km)}</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Godi≈°te:</span>
                            <span>${car.year}</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Snaga:</span>
                            <span>${car.kw} kW / ${car.ks} KS</span>
                        </div>
                        ${car.fuel ? `<div class="spec-item">
                            <span class="spec-label">Gorivo:</span>
                            <span>${car.fuel}</span>
                        </div>` : ''}
                    </div>
                    ${admin ? `
                        <div class="car-buttons">
                            <button class="load-more-btn" onclick="event.stopPropagation(); openCarModal(${idx})">
                                Pogledaj detalje
                            </button>
                            <button class="delete-btn" onclick="event.stopPropagation(); console.log('DELETE clicked for car ${idx}'); removeCar(${idx})">
                                Obri≈°i
                            </button>
                        </div>
                    ` : `
                        <button class="load-more-btn" onclick="event.stopPropagation(); openCarModal(${idx})">
                            Pogledaj detalje
                        </button>
                    `}
                </div>
            `;
            
            // ISPRAVKA - Postaviti pravilnu strukturu kartice
            card.innerHTML = `
                <div style="position:relative;overflow:hidden;border-radius:20px 20px 0 0;">
                    ${imageHtml}
                </div>
                ${specs}
            `;
            grid.appendChild(card);
        });
        
        // FINALNI IZVE≈†TAJ - sada koristi taƒçne statistike
        console.log(`üöÄ KARTICE KREIRANE:`);
        console.log(`‚Ä¢ Prikazano automobila: ${cars.length}`);
        console.log(`‚Ä¢ Poku≈°aj uƒçitavanja preview slika u toku...`);
        
        // Timer za finalne taƒçne statistike
        setTimeout(() => {
            console.log(`üìà FINALNE TAƒåNE STATISTIKE (nakon 5s):`);
            updateRealImageStatistics();
            
            // Detaljana analiza slika
            analyzeImageStatus();
            
        }, 5000);
        
        // Dodatni timer za finalni pregled nakon 10 sekundi
        setTimeout(() => {
            console.log(`üèÅ KONAƒåNA ANALIZA (nakon 10s):`);
            const finalResults = analyzeImageStatus();
            
            if (finalResults.loading > 0) {
                console.log(`‚ö†Ô∏è NAPOMENA: ${finalResults.loading} slika jo≈° uvek poku≈°ava fallback opcije`);
            }
            
            if (finalResults.broken > 0) {
                console.log(`‚ùå PROBLEMATIƒåNE SLIKE: ${finalResults.broken} slika se nisu uƒçitale ni sa jednim proxy-jem`);
                
                // SAMO OBAVE≈†TENJE - ne bri≈°e automatski
                console.log(`‚ÑπÔ∏è  DOSTUPNE OPCIJE U CONSOLE:`);
                console.log(`‚Ä¢ runCompleteSystemTest() - üÜï KOMPLETNO TESTIRANJE SISTEMA`);
                console.log(`‚Ä¢ analyzeOnly() - samo analiziraj bez brisanja`);
                console.log(`‚Ä¢ cleanImagesForCar(index) - ƒçisti samo jedan automobil`);
                console.log(`‚Ä¢ restoreOldCarsImages() - obnovi izgubljene slike`);
                console.log(`‚Ä¢ cleanHttpErrorImages() - bri≈°e samo HTTP error slike`);
                console.log(`‚Ä¢ conservativeCleanUp() - bri≈°e samo sigurno lo≈°e slike`);
                console.log(`‚Ä¢ smartCleanUpBrokenImages() - UBRZANO pametno ƒçi≈°ƒáenje`);
                console.log(`‚Ä¢ manualCleanUp() - kompletno ƒçi≈°ƒáenje`);
                console.log(`‚Ä¢ clearImageTestCache() - obri≈°i cache testova za fresh start`);
                console.log(`‚Ä¢ refreshCatalogImages() - OSVEZI katalog (re≈°ava problem izgubljenih slika)`);
            }
        }, 10000);
        
        // DODATNI TIMER - Jo≈° detaljnija analiza nakon 15 sekundi
        setTimeout(() => {
            console.log(`üî¨ FINALNA DETALJNA ANALIZA (nakon 15s):`);
            const detailedResults = analyzeImageStatusAdvanced();
            
            if (detailedResults.brokenUrls.length > 0) {
                // SAMO OBAVE≈†TENJE O DOSTUPNIM OPCIJAMA
                console.log(`üö® IDENTIFIKOVANI PROBLEMATIƒåNI URL-OVI:`);
                detailedResults.brokenUrls.forEach((url, i) => {
                    console.log(`${i + 1}. ${url}`);
                });
                
                console.log(`‚ÑπÔ∏è  MANUALNE OPCIJE U CONSOLE:`);
                console.log(`‚Ä¢ analyzeOnly() - detaljno analiziranje bez izmena`);
                console.log(`‚Ä¢ conservativeCleanUp() - sigurno ƒçi≈°ƒáenje`);
                console.log(`‚Ä¢ smartCleanUpBrokenImages() - UBRZANO pametno ƒçi≈°ƒáenje`);
                console.log(`‚Ä¢ clearImageTestCache() - obri≈°i cache testova`);
                console.log(`‚Ä¢ refreshCatalogImages() - OSVEZI katalog (vrati slike)`);
            }
        }, 15000);
    }

    // NOVA FUNKCIJA - Precizno brisanje slika po URL-ovima SA SIGURNOSNOM PROVEROM
    function cleanUpBrokenImagesByUrls(brokenUrls) {
        if (!brokenUrls || brokenUrls.length === 0) return;
        
        console.log(`üéØ PRECIZNO ƒåI≈†ƒÜENJE ${brokenUrls.length} PROBLEMATIƒåNIH URL-OVA...`);
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let totalCleaned = 0;
        let carsModified = 0;
        
        cars.forEach((car, carIndex) => {
            if (!car.images || car.images.length === 0) return;
            
            const originalCount = car.images.length;
            const cleanedImages = car.images.filter(imageUrl => {
                const isBroken = brokenUrls.includes(imageUrl);
                if (isBroken) {
                    console.log(`üóëÔ∏è Bri≈°em iz ${car.model}: ${imageUrl.substring(0, 60)}...`);
                    totalCleaned++;
                }
                return !isBroken;
            });
            
            if (cleanedImages.length !== originalCount) {
                if (cleanedImages.length > 0) {
                    // Ima preostale funkcionalne slike
                    car.images = cleanedImages;
                    carsModified++;
                    console.log(`‚úÇÔ∏è ${car.model}: ${originalCount} ‚Üí ${cleanedImages.length} slika`);
                } else {
                    // SVE slike su problematiƒçne - dodeli placeholder
                    console.log(`üö® ${car.model}: Sve slike problematiƒçne - dodeljujem placeholder`);
                    car.images = ['https://via.placeholder.com/400x300/cccccc/666666?text=Nema+Slika'];
                    carsModified++;
                }
            }
        });
        
        // Saƒçuvaj promene
        if (carsModified > 0) {
            localStorage.setItem('cars', JSON.stringify(cars));
            
            console.log(`üèÜ PRECIZNO ƒåI≈†ƒÜENJE ZAVR≈†ENO:`);
            console.log(`‚Ä¢ Uklonjeno URL-ova: ${totalCleaned}`);
            console.log(`‚Ä¢ A≈æurirano automobila: ${carsModified}`);
            console.log(`‚Ä¢ Automatski saƒçuvano ‚úÖ`);
            
            // Osve≈æi katalog sa oƒçi≈°ƒáenim podacima
            setTimeout(() => {
                console.log(`üîÑ Refreshing catalog with cleaned data...`);
                renderCatalogOnLoad();
            }, 2000);
        } else {
            console.log(`‚ú® Svi URL-ovi su veƒá oƒçi≈°ƒáeni!`);
        }
    }

    // NOVA FUNKCIJA - Dodeljuje placeholder slike za automobile bez slika
    function assignPlaceholderImages() {
        console.log(`üñºÔ∏è DODELJUJEM PLACEHOLDER SLIKE...`);
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let carsFixed = 0;
        
        cars.forEach((car, index) => {
            if (!car.images || car.images.length === 0) {
                // Dodeli placeholder sliku
                car.images = ['https://via.placeholder.com/400x300/cccccc/666666?text=Nema+Slika'];
                carsFixed++;
                console.log(`üîß ${car.model}: Dodeljujem placeholder sliku`);
            }
        });
        
        if (carsFixed > 0) {
            localStorage.setItem('cars', JSON.stringify(cars));
            console.log(`‚úÖ Dodeljeno ${carsFixed} placeholder slika`);
            
            // Osvezi katalog
            setTimeout(() => {
                renderCatalogOnLoad();
            }, 500);
        } else {
            console.log(`‚ú® Svi automobili veƒá imaju slike!`);
        }
    }

    // NOVA FUNKCIJA - Manualni poziv za ƒçi≈°ƒáenje (za testing/debug)
    function manualCleanUp() {
        console.log(`üßπ MANUALNO ƒåI≈†ƒÜENJE POKRENUTO...`);
        analyzeImageStatusAdvanced();
        setTimeout(() => {
            smartCleanUpBrokenImages(); // Koristi pametno ƒçi≈°ƒáenje
        }, 1000);
        setTimeout(() => {
            assignPlaceholderImages();
        }, 3000);
    }

    // UBRZANA ANALIZA - Paralelno testiranje bez brisanja
    async function analyzeOnly() {
        console.log(`ÔøΩ UBRZANA ANALIZA - Paralelno testiranje bez brisanja...`);
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        
        // Procesiraj automobile u batch-ovima od 3
        const BATCH_SIZE = 3;
        
        for (let i = 0; i < cars.length; i += BATCH_SIZE) {
            const batch = cars.slice(i, i + BATCH_SIZE);
            
            await Promise.all(batch.map(async (car, localIndex) => {
                const carIndex = i + localIndex;
                if (!car.images || car.images.length === 0) return;
                
                console.log(`üìä ${car.model} - Analiziram ${car.images.length} slika:`);
                
                // Testiraj sve slike paralelno
                const imageTests = car.images.map(async (imageUrl, imageIndex) => {
                    let isWorking = await testImageUrl(imageUrl);
                    
                    if (!isWorking) {
                        // Test samo jedan proxy za brzinu
                        const weservUrl = 'https://images.weserv.nl/?url=' + encodeURIComponent(imageUrl);
                        isWorking = await testImageUrl(weservUrl);
                    }
                    
                    return { imageUrl, isWorking, index: imageIndex };
                });
                
                const results = await Promise.all(imageTests);
                
                // Prika≈æi rezultate
                results.forEach(result => {
                    if (result.isWorking) {
                        console.log(`   ‚úÖ Slika ${result.index + 1}: RADI`);
                    } else {
                        console.log(`   ‚ùå Slika ${result.index + 1}: PROBLEMATIƒåNA - ${result.imageUrl.substring(0, 60)}...`);
                    }
                });
            }));
            
            // Kratka pauza izmeƒëu batch-ova
            if (i + BATCH_SIZE < cars.length) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
        
        console.log(`üîç UBRZANA ANALIZA ZAVR≈†ENA - Nema automatskih izmena`);
    }

    // NOVA FUNKCIJA - Konzervativno ƒçi≈°ƒáenje (bri≈°e samo oƒçigledno lo≈°e)
    async function conservativeCleanUp() {
        console.log(`‚öñÔ∏è KONZERVATIVNO ƒåI≈†ƒÜENJE - Bri≈°e samo sigurno lo≈°e slike...`);
        
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        let totalCleaned = 0;
        let carsModified = 0;
        
        for (let carIndex = 0; carIndex < cars.length; carIndex++) {
            const car = cars[carIndex];
            if (!car.images || car.images.length === 0) continue;
            
            const originalCount = car.images.length;
            const cleanedImages = [];
            
            for (let imageIndex = 0; imageIndex < car.images.length; imageIndex++) {
                const imageUrl = car.images[imageIndex];
                
                // KONZERVATIVNI TEST - bri≈°e samo ako SVI poku≈°aji ne rade
                let directWorks = await testImageUrl(imageUrl);
                let weservWorks = await testImageUrl('https://images.weserv.nl/?url=' + encodeURIComponent(imageUrl));
                let alloriginsWorks = await testImageUrl('https://api.allorigins.win/raw?url=' + encodeURIComponent(imageUrl));
                
                // ƒåuva sliku ako BILO KOJI naƒçin radi
                if (directWorks || weservWorks || alloriginsWorks) {
                    cleanedImages.push(imageUrl);
                    console.log(`   ‚úÖ ${car.model} slika ${imageIndex + 1}: ƒåUVAM (radi preko nekog proxy-ja)`);
                } else {
                    console.log(`   üóëÔ∏è ${car.model} slika ${imageIndex + 1}: BRI≈†EM (ne radi nikako)`);
                    totalCleaned++;
                }
            }
            
            // A≈æuriraj samo ako je stvarno potrebno
            if (cleanedImages.length < originalCount && cleanedImages.length > 0) {
                car.images = cleanedImages;
                carsModified++;
                console.log(`üìù ${car.model}: ${originalCount} ‚Üí ${cleanedImages.length} slika`);
            } else if (cleanedImages.length === 0) {
                // Sve obrisane - dodeli placeholder
                car.images = ['https://via.placeholder.com/400x300/e8e8e8/999999?text=' + encodeURIComponent(car.model || 'Auto')];
                carsModified++;
                console.log(`üîß ${car.model}: Dodeljujem placeholder jer su sve slike lo≈°e`);
            }
        }
        
        if (carsModified > 0) {
            localStorage.setItem('cars', JSON.stringify(cars));
            console.log(`‚öñÔ∏è KONZERVATIVNO ƒåI≈†ƒÜENJE: ${totalCleaned} slika uklonjeno, ${carsModified} automobila a≈æurirano`);
            
            setTimeout(() => renderCatalogOnLoad(), 1000);
        } else {
            console.log(`‚ú® Nema potrebe za ƒçi≈°ƒáenjem!`);
        }
    }

    function searchCatalog() {
        const value = document.getElementById('searchBar').value.trim().toLowerCase();
        lastSearchValue = value;
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        const filtered = cars.filter(car => car.model && car.model.toLowerCase().includes(value));
        renderCatalog(filtered);
    }

    // Enter za pretragu
    document.addEventListener('DOMContentLoaded', function() {
        const searchBar = document.getElementById('searchBar');
        if (searchBar) {
            searchBar.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') searchCatalog();
                if (e.key === 'Escape') { searchBar.value = ''; renderCatalog(); }
            });
        }
    });

    // Prikaz svih automobila na poƒçetku ili nakon brisanja
    function renderCatalogOnLoad() {
        if (lastSearchValue && lastSearchValue.length > 0) {
            searchCatalog();
        } else {
            renderCatalog();
        }
    }
    // Modal logic for car details
    function openCarModal(idx) {
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        const car = cars[idx];
        if (!car) return;
        
        // Postavi globalne varijable za fullscreen galeriju
        window.currentModalImages = car.images || [];
        
        lockScroll();
        const overlay = document.getElementById('carModalOverlay');
        const content = document.getElementById('carModalContent');
        let current = 0;
        // Modal slider HTML sa sigurnim uƒçitavanjem
        let imagesHtml = createSafeModalSlider(car);
        
        // Car details
        let statsHtml = `
            <div style="width:100%;max-width:820px;margin:0 auto 0 auto;padding:0 0 24px 0;">
                <div style="background:#f7f7f7;border-radius:12px;padding:28px 32px 22px 32px;box-shadow:0 2px 12px rgba(44,62,80,0.07);margin-top:0;color:#111;">
                    <h3 style="color:#e74c3c;font-size:1.35rem;text-align:left;margin-bottom:18px;letter-spacing:1px;">Detalji vozila</h3>
                    <div class="car-specs" style="font-size:1.13rem;margin-bottom:10px;color:#111;"><b>Model:</b> ${car.model}</div>
                    <div class="car-specs" style="font-size:1.13rem;margin-bottom:10px;color:#111;"><b>Kilometra≈æa:</b> ${formatKm(car.km)}</div>
                    <div class="car-specs" style="font-size:1.13rem;margin-bottom:10px;color:#111;"><b>Godi≈°te:</b> ${car.year}</div>
                    <div class="car-specs" style="font-size:1.13rem;margin-bottom:10px;color:#111;"><b>Jaƒçina motora:</b> ${car.kw} kW / ${car.ks} KS</div>
                    ${car.fuel ? `<div class="car-specs" style="font-size:1.13rem;margin-bottom:10px;color:#111;"><b>Vrsta goriva:</b> ${car.fuel}</div>`:''}
                    ${car.engine ? `<div class="car-specs" style="font-size:1.13rem;margin-bottom:10px;color:#111;"><b>Motor:</b> ${car.engine}</div>`:''}
                    <div class="car-specs" style="font-size:1.13rem;margin-bottom:10px;color:#111;"><b>Cena:</b> <span style='color:#27ae60;font-weight:600;'>‚Ç¨${formatPrice(car.price)}</span></div>
                    <div class="car-specs" style="font-size:1.13rem;margin-bottom:0;color:#111;"><b>Napomena:</b> <span style='color:#111;'>${car.desc ? car.desc : 'Nema dodatnih informacija.'}</span></div>
                </div>
            </div>
        `;
        content.innerHTML = imagesHtml + statsHtml;
        overlay.style.display = 'flex';
        
        // A≈ΩURIRANJE THUMBNAILS - Samo a≈æuriraj statistike bez agresivnog sakrivanja
        setTimeout(() => {
            updateRealImageStatistics();
        }, 1000);
        
        // Modal slider logic
        if (car.images && car.images.length > 1) {
            const mainImg = content.querySelector('.modal-slider-main');
            const thumbs = content.querySelectorAll('.modal-slider-thumbs img');
            let current = 0;
            function showImg(i) {
                current = i;
                mainImg.src = car.images[i];
                thumbs.forEach((t, idx) => t.style.opacity = idx===i ? '1' : '0.6');
            }
            const prevBtn = content.querySelector('.modal-slider-prev');
            const nextBtn = content.querySelector('.modal-slider-next');
            if (prevBtn) prevBtn.onclick = function(e) { e.stopPropagation(); showImg((current-1+car.images.length)%car.images.length); };
            if (nextBtn) nextBtn.onclick = function(e) { e.stopPropagation(); showImg((current+1)%car.images.length); };
            thumbs.forEach((t, idx) => t.onclick = (e) => { e.stopPropagation(); showImg(idx); });
        }
    }

    function closeCarModal() {
    unlockScroll();
        document.getElementById('carModalOverlay').style.display = 'none';
    }

    // Modal close logic for car modal
    document.addEventListener('DOMContentLoaded', function() {
        var closeBtn = document.getElementById('closeCarModalBtn');
        if (closeBtn) closeBtn.onclick = closeCarModal;
        var overlay = document.getElementById('carModalOverlay');
        if (overlay) overlay.onclick = function(e) {
            if (e.target === overlay) closeCarModal();
        };
    });
    // Custom file input UI
    document.addEventListener('DOMContentLoaded', function(){
        const fileInput = document.getElementById('carImages');
        const trigger = document.getElementById('carImagesTrigger');
        const info = document.getElementById('carImagesInfo');
        if(trigger && fileInput && info){
            trigger.addEventListener('click', ()=> fileInput.click());
            fileInput.addEventListener('change', ()=>{
                if(!fileInput.files || fileInput.files.length===0){
                    info.textContent = 'Nijedna slika nije izabrana';
                    return;
                }
                if(fileInput.files.length === 1){
                    info.textContent = `1 slika izabrana (${(fileInput.files[0].size/1024/1024).toFixed(1)}MB)`;
                } else {
                    const totalSize = Array.from(fileInput.files).reduce((sum, file) => sum + file.size, 0);
                    info.textContent = `${fileInput.files.length} slika izabrano (ukupno ${(totalSize/1024/1024).toFixed(1)}MB)`;
                }
            });
        }
        // Live kW -> KS hint
        const kwInput = document.getElementById('carKw');
        const kwHint = document.getElementById('kwToKsHint');
        if(kwInput && kwHint){
            const updateKs = ()=>{
                const v = parseInt(kwInput.value,10);
                if(isNaN(v) || v<=0){ kwHint.textContent = '= 0 KS'; return; }
                kwHint.textContent = '= ' + Math.round(v*1.35962) + ' KS';
            };
            kwInput.addEventListener('input', updateKs);
            updateKs();
        }
    });
    // Formatiranje kilometra≈æe sa zarezima
    function formatKm(km) {
        if (!km) return '';
        return km.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' km';
    }
    
    // Formatiranje cene sa taƒçkama
    function formatPrice(price) {
        if (!price) return '';
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    function removeCar(idx) {
        if (!isAdmin()) return;
        const cars = JSON.parse(localStorage.getItem('cars') || '[]');
        cars.splice(idx, 1);
        localStorage.setItem('cars', JSON.stringify(cars));
        renderCatalog();
    }
    // Log Out dugme veƒá radi reload, ali za svaki sluƒçaj osve≈æi UI i na localStorage promenu
    window.addEventListener('storage', function(e) {
        if (e.key === 'apm_admin') {
            window.location.reload();
        }
    });

    // Uƒçitaj oglase pri pokretanju stranice
    document.addEventListener('DOMContentLoaded', function() {
        renderCatalog();
        // updateStorageStatus(); // uklonjeno
        
        // AUTO-FORMATIRANJE URL POLJA
        const urlTextarea = document.getElementById('carImageUrls');
        if (urlTextarea) {
            urlTextarea.addEventListener('blur', function() {
                const text = this.value;
                if (text.trim()) {
                    console.log('üîÑ Auto-formatiranje URL-ova...');
                    
                    // Pronaƒëi sve URL-ove koristeƒái regex
                    const urlPattern = /https?:\/\/[^\s]+/g;
                    const urls = text.match(urlPattern) || [];
                    
                    // Formatraj svaki URL u novi red
                    const formatted = urls
                        .map(url => url.replace(/[,;.\s]+$/, '').trim())
                        .filter(url => url.length > 10)
                        .join('\n');
                    
                    if (formatted !== text.trim()) {
                        this.value = formatted;
                        console.log(`‚úÖ Formatiran sadr≈æaj: ${urls.length} URL-ova`);
                    }
                }
            });
        }
    });
    
    // Mobilni meni funkcionalnost
    function toggleMobileMenu() {
        const navLinks = document.getElementById('navLinks');
        const body = document.body;
        
        navLinks.classList.toggle('active');
        
        if (navLinks.classList.contains('active')) {
            body.style.overflow = 'hidden';
        } else {
            body.style.overflow = '';
        }
    }
    
    // Zatvaranje menija klikom van njega
    document.addEventListener('click', function(event) {
        const navLinks = document.getElementById('navLinks');
        const mobileToggle = document.querySelector('.mobile-menu-toggle');
        
        if (navLinks.classList.contains('active') && 
            !navLinks.contains(event.target) && 
            !mobileToggle.contains(event.target)) {
            navLinks.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
    
    // Zatvaranje menija pritiskom Escape tastera
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const navLinks = document.getElementById('navLinks');
            if (navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
    });
    
    // Zatvaranje menija pri promeni veliƒçine ekrana
    window.addEventListener('resize', function() {
        const navLinks = document.getElementById('navLinks');
        if (window.innerWidth > 768 && navLinks.classList.contains('active')) {
            navLinks.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
    
    // Zatvaranje menija pri navigaciji
    document.querySelectorAll('.nav-links a').forEach(link => {
        link.addEventListener('click', function() {
            const navLinks = document.getElementById('navLinks');
            if (navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });
    
    // Fullscreen galerija funkcionalnost
    let currentFullscreenImages = [];
    let currentFullscreenIndex = 0;
    
    function openFullscreenGallery(images, startIndex = 0) {
        currentFullscreenImages = images || [];
        currentFullscreenIndex = startIndex;
        
        if (currentFullscreenImages.length === 0) return;
        
        const gallery = document.getElementById('fullscreenGallery');
        const image = document.getElementById('fullscreenImage');
        const counter = document.getElementById('fullscreenCounter');
        
        updateFullscreenImage();
        gallery.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Keyboard navigation
        document.addEventListener('keydown', handleFullscreenKeyboard);
    }
    
    function closeFullscreenGallery() {
        const gallery = document.getElementById('fullscreenGallery');
        gallery.style.display = 'none';
        document.body.style.overflow = '';
        
        // Remove keyboard listener
        document.removeEventListener('keydown', handleFullscreenKeyboard);
    }
    
    function navigateFullscreen(direction) {
        if (currentFullscreenImages.length <= 1) return;
        
        currentFullscreenIndex += direction;
        
        if (currentFullscreenIndex >= currentFullscreenImages.length) {
            currentFullscreenIndex = 0;
        } else if (currentFullscreenIndex < 0) {
            currentFullscreenIndex = currentFullscreenImages.length - 1;
        }
        
        updateFullscreenImage();
    }
    
    function updateFullscreenImage() {
        const image = document.getElementById('fullscreenImage');
        const counter = document.getElementById('fullscreenCounter');
        
        if (currentFullscreenImages.length > 0) {
            image.src = currentFullscreenImages[currentFullscreenIndex];
            counter.textContent = `${currentFullscreenIndex + 1} / ${currentFullscreenImages.length}`;
            
            // Hide navigation if only one image
            const prevBtn = document.querySelector('.fullscreen-prev');
            const nextBtn = document.querySelector('.fullscreen-next');
            if (currentFullscreenImages.length <= 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            }
        }
    }
    
    function handleFullscreenKeyboard(event) {
        switch(event.key) {
            case 'Escape':
                closeFullscreenGallery();
                break;
            case 'ArrowLeft':
                navigateFullscreen(-1);
                break;
            case 'ArrowRight':
                navigateFullscreen(1);
                break;
        }
    }
    
    // Zatvaranje fullscreen galerije klikom na pozadinu
    document.getElementById('fullscreenGallery').addEventListener('click', function(event) {
        if (event.target === this) {
            closeFullscreenGallery();
        }
    });
    
    // Helper funkcija za otvaranje fullscreen-a iz modal-a
    function openFullscreenFromModal(startIndex = 0) {
        if (window.currentModalImages && window.currentModalImages.length > 0) {
            openFullscreenGallery(window.currentModalImages, startIndex);
        } else {
            alert('Nema slika za prikaz u fullscreen');
        }
    }
    </script>
    
    <!-- Fullscreen galerija za slike -->
    <div id="fullscreenGallery" class="fullscreen-gallery">
        <div class="fullscreen-content">
            <button class="fullscreen-close" onclick="closeFullscreenGallery()">&times;</button>
            <button class="fullscreen-nav fullscreen-prev" onclick="navigateFullscreen(-1)">‚Äπ</button>
            <button class="fullscreen-nav fullscreen-next" onclick="navigateFullscreen(1)">‚Ä∫</button>
            <img id="fullscreenImage" class="fullscreen-image" src="" alt="Fullscreen slika">
            <div id="fullscreenCounter" class="fullscreen-counter">1 / 1</div>
        </div>
    </div>
</body>

</html>
